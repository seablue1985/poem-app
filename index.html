<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- ğŸ“± PWA æ ¸å¿ƒé…ç½® -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#e0f2f1"> <!-- è¿™é‡Œçš„é¢œè‰²è¦å’Œæ‚¨çš„èƒŒæ™¯è‰²ä¸€è‡´ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655562.png"> <!-- è¿™é‡Œå¯ä»¥æ¢æˆæ‚¨å–œæ¬¢çš„å›¾æ ‡é“¾æ¥ -->
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3655/3655562.png">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// æ›¿æ¢åŸæ¥çš„APIè®¾ç½®
const supabaseUrl = 'https://ntrrijirsqluulvpgxoj.supabase.co';
const supabaseKey = 'sb_publishable_ttBOGdcAgCZSExC3Yitx0w_oSFN6P18';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// ä¿®æ”¹apiCallå‡½æ•°
async function apiCall(endpoint, payload) {
  try {
    if (endpoint === '/register') {
      const { email, password, initialData } = payload;
      const { data, error } = await supabase
        .from('users')
        .insert([{
          email,
          password_hash: password, // å®é™…åº”ç”¨ä¸­åº”è¯¥åŠ å¯†
          poem_data: initialData
        }]);

      return error ? { success: false, error: error.message } : { success: true };
    }

    if (endpoint === '/login') {
      const { email, password } = payload;
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('email', email)
        .eq('password_hash', password)
        .single();

      if (error || !data) {
        return { success: false, error: 'ç”¨æˆ·ä¸å­˜åœ¨æˆ–å¯†ç é”™è¯¯' };
      }

      return { success: true, data: data.poem_data || [] };
    }

    // ç±»ä¼¼ä¿®æ”¹å…¶ä»–ç«¯ç‚¹
  } catch(e) {
    return { success: false, error: e.message };
  }
}
</script>
    
<style>
    /* ğŸ“± é’ˆå¯¹æ‰‹æœº App æ¨¡å¼çš„é¢å¤–ä¼˜åŒ– */
    @media (max-width: 768px) {
        body { padding-bottom: 40px; } /* é˜²æ­¢åº•éƒ¨è¢«æ‰‹æœºæ¨ªæ¡æŒ¡ä½ */
        .app-container { padding: 10px; gap: 15px; height: auto; }
        .sidebar, .main-content { border-radius: 15px; padding: 15px; }
        /* è®©æ‰‹æœºä¸Šå­—ä½“ç¨å¾®å¤§ä¸€ç‚¹ */
        .task-card h4 { font-size: 18px; }
        .poem-card b { font-size: 18px; }
    }
</style>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤è¯—Â·äº‘ç«¯é›…é›†</title>
    <style>
        :root {
            /* ğŸŸ¢ æ ¸å¿ƒé…è‰²ï¼šæ¸…æ–°æŠ¤çœ¼ç»¿ */
            --bg-gradient: linear-gradient(135deg, #e0f2f1 0%, #a7f3d0 100%); /* æ™¨é›¾ç»¿æ¸å˜ */
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --primary: #059669;    /* ç¿¡ç¿ ç»¿ - ä¸»æŒ‰é’®/é‡ç‚¹ */
            --primary-dark: #047857;
            --secondary: #34d399;  /* å«©èŠ½ç»¿ - è£…é¥° */
            --text-main: #1f2937;  /* æ·±ç° - æ­£æ–‡ */
            --text-sub: #4b5563;   /* æµ…ç° - è¾…åŠ©æ–‡å­— */
            --accent-red: #ef4444; /* é€¾æœŸ/é”™è¯¯ */
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body {
            background: var(--bg-gradient);
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* === å¸ƒå±€å®¹å™¨ === */
        .app-container {
            max-width: 1600px; /* å®½å±é€‚é… */
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr; /* å·¦ä¾§å›ºå®š320pxï¼Œå³ä¾§è‡ªé€‚åº” */
            gap: 25px;
            height: 95vh;
        }

        /* === å…¬å…±å¡ç‰‡æ ·å¼ (æ¯›ç»ç’ƒ) === */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        /* === å·¦ä¾§è¾¹æ  (ä¿¡æ¯æµ) === */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .brand-area h1 {
            font-size: 24px;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ç™»å½•æ¡ */
        .auth-widget {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; display: inline-block; }
        .status-dot.online { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        /* ç»Ÿè®¡å— */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-num { font-size: 24px; font-weight: 800; color: var(--primary); display: block; }
        .stat-desc { font-size: 12px; color: var(--text-sub); }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .task-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border-left: 5px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }
        .task-card:hover { transform: translateX(5px); }
        .task-card.new { border-left-color: var(--primary); }
        .task-card.review { border-left-color: #10b981; }
        .task-card.overdue { border-left-color: var(--accent-red); }
        .task-card h4 { margin: 0 0 5px 0; font-size: 16px; }
        
        /* æ ‡ç­¾ */
        .badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 4px;
        }
        .bg-new { background: var(--primary); }
        .bg-rev { background: #10b981; }
        .bg-ovd { background: var(--accent-red); }

        /* === å³ä¾§ä¸»åŒºåŸŸ (ä¹¦åº“) === */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow: hidden; /* é˜²æ­¢æ’‘å¼€é¡µé¢ */
        }

        .toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            outline: none;
            transition: box-shadow 0.3s;
        }
        .search-bar:focus { box-shadow: 0 4px 20px rgba(5, 150, 105, 0.15); }

        .btn-icon {
            width: 46px; height: 46px;
            border-radius: 12px;
            border: none;
            background: white;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-icon:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        /* è¯—è¯ç½‘æ ¼ (è‡ªé€‚åº”å®½å±) */
        .library-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 5px; /* é˜²æ­¢é˜´å½±è¢«åˆ‡ */
        }
        .poem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* å®½å±è‡ªé€‚åº”åˆ—æ•° */
            gap: 15px;
        }
        
        .poem-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
        }
        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.1);
            border-color: var(--secondary);
        }
        .poem-card b { display: block; font-size: 18px; margin-bottom: 5px; color: var(--text-main); }
        .poem-card small { color: #888; font-size: 13px; }
        .poem-card.learned { opacity: 0.6; background: #f9fafb; }
        .poem-card.learned::after {
            content: "âœ…"; position: absolute; top: 10px; right: 10px; font-size: 12px;
        }

        /* === æŒ‰é’®é€šç”¨ === */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-text { background: none; color: var(--primary); }
        
        /* === å¼¹çª—æ ·å¼ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-card {
            background: white;
            width: 500px;
            max-width: 90%;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .poem-content-display {
            font-family: "KaiTi", "STKaiti", "æ¥·ä½“", serif;
            font-size: 26px;
            line-height: 1.8;
            background: #f0fdf4;
            padding: 25px;
            border-radius: 16px;
            margin: 20px 0;
            color: #064e3b;
            white-space: pre-wrap;
            border: 1px dashed #6ee7b7;
        }

        /* è¾“å…¥æ¡†ç¾åŒ– */
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-top: 5px; box-sizing: border-box; }

        /* å“åº”å¼ï¼šæ‰‹æœºç«¯å˜ä¸ºå•åˆ— */
        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; height: auto; padding: 15px; }
            .sidebar { height: auto; overflow: visible; }
            .main-content { height: auto; }
            .library-scroll { overflow: visible; }
            .poem-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 2000; }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <div class="app-container">
        <!-- å·¦ä¾§è¾¹æ ï¼šçŠ¶æ€ä¸ä»»åŠ¡ -->
        <aside class="sidebar glass-card">
            <div class="brand-area">
                <h1>ğŸƒ å¤è¯—Â·äº‘ç«¯é›…é›†</h1>
                <p style="font-size:12px; color:#666; margin-top:5px;">è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ Â· æ™ºèƒ½è§„åˆ’</p>
            </div>

            <!-- ç™»å½•çŠ¶æ€ -->
            <div class="auth-widget">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="user-name" style="font-weight:600; color:#374151;">æœ¬åœ°è®¿å®¢</span>
                </div>
                <button class="btn-text" onclick="showAuth()" style="font-size:12px;">åˆ‡æ¢è´¦å·</button>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="stats-row">
                <div class="stat-box">
                    <span class="stat-num" id="count-todo">0</span>
                    <span class="stat-desc">ä»Šæ—¥å¾…åŠ</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="count-done">0</span>
                    <span class="stat-desc">å·²ç†ŸèƒŒ</span>
                </div>
            </div>

            <!-- ä»Šæ—¥ä»»åŠ¡ -->
            <div>
                <h3 style="margin-bottom:15px; color:#374151; display:flex; justify-content:space-between; align-items:center;">
                    ğŸ“… ä»Šæ—¥ä»»åŠ¡
                    <span style="font-size:12px; font-weight:normal; color:#888;">ç‚¹æ­¤å¼€å§‹èƒŒè¯µ</span>
                </h3>
                <div id="task-list" class="task-list">
                    <!-- ä»»åŠ¡å¡ç‰‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸï¼šè—ä¹¦é˜ -->
        <main class="main-content glass-card">
            <div class="toolbar">
                <input type="text" id="search" class="search-bar" placeholder="ğŸ” æœç´¢è¯—è¯åº“ (å¦‚ï¼šæç™½ã€æ˜¥æ™“)..." oninput="renderUI()">
                <button class="btn-icon" onclick="showImport()" title="å¯¼å…¥æ–°è¯—">â•</button>
                <button class="btn-icon" onclick="resetAll()" title="æ¸…ç©ºé‡ç½®" style="color:var(--accent-red)">â†»</button>
            </div>

            <h3 style="margin:10px 0; color:#374151;">ğŸ“š è—ä¹¦é˜ (ç‚¹å‡»å¡ç‰‡å­¦ä¹ )</h3>
            
            <div class="library-scroll">
                <div id="lib-grid" class="poem-grid">
                    <!-- è¯—è¯å¡ç‰‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </main>
    </div>

    <!-- å¼¹çª—ï¼šç™»å½• -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-card">
            <h2>â˜ï¸ äº‘ç«¯åŒæ­¥</h2>
            <p style="color:#666; font-size:14px;">ç™»å½•åï¼Œæ‚¨çš„èƒŒè¯µè¿›åº¦å°†åœ¨æ‰€æœ‰è®¾å¤‡é—´è‡ªåŠ¨åŒæ­¥ã€‚</p>
            <div class="input-group">
                <input type="text" id="email" class="input-field" placeholder="è¯·è¾“å…¥é‚®ç®±æˆ–ç”¨æˆ·å">
                <input type="password" id="password" class="input-field" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="doLogin()">ç™»å½•å¹¶åŒæ­¥</button>
            <button class="btn btn-text" style="width:100%; margin-top:10px;" onclick="doRegister()">æ³¨å†Œæ–°è´¦å·</button>
            <div id="auth-msg" style="color:red; margin-top:10px; font-size:12px;"></div>
            <button class="btn-text" onclick="closeModal('auth-modal')" style="position:absolute; top:15px; right:15px; font-size:20px;">Ã—</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šèƒŒè¯µç•Œé¢ -->
    <div id="study-modal" class="modal-overlay">
        <div class="modal-card" style="width:600px;">
            <span id="study-tag" class="badge bg-new" style="font-size:12px; padding:4px 10px;">æ–°å­¦</span>
            <h2 id="s-title" style="margin:10px 0; font-size:28px; color:#064e3b;"></h2>
            <div id="s-author" style="color:#6b7280; font-weight:500;"></div>
            
            <div id="s-text" class="poem-content-display"></div>
            
            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="btn" style="background:#f3f4f6; color:#666; flex:1;" onclick="closeModal('study-modal')">ç¨åå¤ä¹ </button>
                <button class="btn btn-primary" style="flex:2; font-size:16px;" onclick="finishTask()">âœ… æˆ‘èƒŒä¸‹æ¥äº†</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¯¼å…¥ -->
    <div id="import-modal" class="modal-overlay">
        <div class="modal-card">
            <h3>æ‰¹é‡å¯¼å…¥è¯—è¯</h3>
            
            <!-- æ ¼å¼é€‰æ‹©å™¨ -->
            <div class="input-group">
                <label style="font-size:14px;">å¯¼å…¥æ ¼å¼:</label>
                <select id="import-format" class="input-field">
                    <option value="pipe">æ ‡é¢˜|ä½œè€…|å†…å®¹ (ä¸€è¡Œä¸€é¦–)</option>
                    <option value="json">JSONæ ¼å¼</option>
                    <option value="plain">æ™®é€šæ–‡æœ¬ (æ ‡é¢˜\nä½œè€…\nå†…å®¹\nç©ºè¡Œåˆ†éš”)</option>
                </select>
            </div>
            
            <!-- æ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
            <div class="input-group">
                <label style="font-size:14px;">è¾“å…¥å†…å®¹:</label>
                <textarea id="import-txt" class="input-field" style="height:120px;" placeholder="æ ¹æ®æ‰€é€‰æ ¼å¼è¾“å…¥å†…å®¹"></textarea>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="input-group">
                <label style="font-size:14px;">æˆ–ä»æ–‡ä»¶å¯¼å…¥:</label>
                <input type="file" id="import-file" class="input-field" accept=".txt,.json" 
                       style="padding:8px;" onchange="handleFileImport(event)">
            </div>
            
            <!-- å¯¼å…¥é€‰é¡¹ -->
            <div class="input-group">
                <label>
                    <input type="checkbox" id="skip-duplicates" checked> è·³è¿‡é‡å¤è¯—è¯
                </label>
                <label style="margin-left:15px;">
                    <input type="checkbox" id="overwrite-existing"> è¦†ç›–é‡å¤è¯—è¯
                </label>
            </div>
            
            <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
            <div id="import-errors" style="color:var(--accent-red); margin:10px 0; font-size:13px; max-height:100px; overflow-y:auto;"></div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="doImport()">ç¡®è®¤å¯¼å…¥</button>
            <button class="btn-text" onclick="closeModal('import-modal')" style="position:absolute; top:15px; right:15px; font-size:20px;">Ã—</button>
        </div>
    </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
// ==========================================
// Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–ï¼ˆä¿®å¤ç‰ˆï¼‰
// ==========================================
const supabaseUrl = 'https://ntrrijirsqluulvpgxoj.supabase.co';
const supabaseKey = 'sb_publishable_ttBOGdcAgCZSExC3Yitx0w_oSFN6P18';

// åˆ›å»º Supabase å®¢æˆ·ç«¯
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
    auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true,
        storage: window.localStorage
    },
    global: {
        headers: {
            'apikey': supabaseKey,
            'Authorization': `Bearer ${supabaseKey}`
        }
    }
});

// ==========================================
// æµ‹è¯•å‡½æ•°ï¼šæ£€æŸ¥ Supabase è¿æ¥
// ==========================================
async function testSupabaseConnection() {
    console.log('ğŸ” æµ‹è¯• Supabase è¿æ¥...');
    
    try {
        // æµ‹è¯• 1: æ£€æŸ¥åŸºæœ¬è¿æ¥
        console.log('æµ‹è¯• 1: æ£€æŸ¥ Supabase æœåŠ¡...');
        const testResponse = await fetch(`${supabaseUrl}/rest/v1/`, {
            headers: {
                'apikey': supabaseKey,
                'Authorization': `Bearer ${supabaseKey}`
            }
        });
        
        if (!testResponse.ok) {
            throw new Error(`API æµ‹è¯•å¤±è´¥: ${testResponse.status}`);
        }
        console.log('âœ… Supabase æœåŠ¡æ­£å¸¸');
        
        // æµ‹è¯• 2: æ£€æŸ¥è®¤è¯æœåŠ¡
        console.log('æµ‹è¯• 2: æ£€æŸ¥è®¤è¯æœåŠ¡...');
        const { data: settings, error: settingsError } = await supabase.auth.getSettings();
        
        if (settingsError) {
            throw new Error(`è®¤è¯æœåŠ¡é”™è¯¯: ${settingsError.message}`);
        }
        console.log('âœ… è®¤è¯æœåŠ¡æ­£å¸¸');
        console.log('è®¾ç½®ä¿¡æ¯:', settings);
        
        // æµ‹è¯• 3: æ£€æŸ¥ users è¡¨
        console.log('æµ‹è¯• 3: æ£€æŸ¥æ•°æ®åº“...');
        const { error: tableError } = await supabase
            .from('users')
            .select('*', { count: 'exact', head: true })
            .limit(1);
            
        if (tableError && tableError.code !== 'PGRST116') {
            console.warn('âš ï¸ æ•°æ®åº“è¡¨å¯èƒ½ä¸å­˜åœ¨æˆ–æƒé™ä¸è¶³:', tableError.message);
        } else {
            console.log('âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸');
        }
        
        return true;
        
    } catch (error) {
        console.error('âŒ Supabase è¿æ¥æµ‹è¯•å¤±è´¥:', error);
        
        // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
        if (error.message.includes('Failed to fetch')) {
            alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ã€‚è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ï¼Œæˆ–ç¨åå†è¯•ã€‚');
        } else if (error.message.includes('API key')) {
            alert('API å¯†é’¥é…ç½®é”™è¯¯ã€‚è¯·æ£€æŸ¥ Supabase è®¾ç½®ã€‚');
        }
        
        return false;
    }
}

// ==========================================
// å…¨å±€å˜é‡
// ==========================================
const defaultData = [
    {id:1,title:"æ±Ÿå—",author:"æ±‰ä¹åºœ",content:"æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ã€‚\né±¼æˆè²å¶é—´ã€‚\né±¼æˆè²å¶ä¸œï¼Œé±¼æˆè²å¶è¥¿ï¼Œ\né±¼æˆè²å¶å—ï¼Œé±¼æˆè²å¶åŒ—ã€‚"},
    {id:2,title:"å’é¹…",author:"éª†å®¾ç‹",content:"é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œæ›²é¡¹å‘å¤©æ­Œã€‚\nç™½æ¯›æµ®ç»¿æ°´ï¼Œçº¢æŒæ‹¨æ¸…æ³¢ã€‚"},
    {id:3,title:"æ˜¥æ™“",author:"å­Ÿæµ©ç„¶",content:"æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚"},
    {id:4,title:"é™å¤œæ€",author:"æç™½",content:"åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚"},
    {id:5,title:"é£",author:"æå³¤",content:"è§£è½ä¸‰ç§‹å¶ï¼Œèƒ½å¼€äºŒæœˆèŠ±ã€‚\nè¿‡æ±Ÿåƒå°ºæµªï¼Œå…¥ç«¹ä¸‡ç«¿æ–œã€‚"},
    {id:6,title:"å’æŸ³",author:"è´ºçŸ¥ç« ",content:"ç¢§ç‰å¦†æˆä¸€æ ‘é«˜ï¼Œä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦ã€‚\nä¸çŸ¥ç»†å¶è°è£å‡ºï¼ŒäºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€ã€‚"}
];

let poems = [];
let curId=null, curType=null, curRevIdx=null;

// ==========================================
// åˆå§‹åŒ–å‡½æ•°
// ==========================================
async function init() {
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–å¤è¯—å­¦ä¹ åº”ç”¨...');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    showLoading('æ­£åœ¨æ£€æŸ¥äº‘ç«¯è¿æ¥...');
    
    try {
        // 1. æµ‹è¯• Supabase è¿æ¥
        const isConnected = await testSupabaseConnection();
        
        if (!isConnected) {
            console.log('åˆ‡æ¢åˆ°çº¯æœ¬åœ°æ¨¡å¼...');
            alert('âš ï¸ æ— æ³•è¿æ¥åˆ°äº‘ç«¯æœåŠ¡ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼ã€‚æ‚¨çš„æ•°æ®å°†ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ã€‚');
            
            // ä½¿ç”¨çº¯æœ¬åœ°æ¨¡å¼
            window.useLocalMode = true;
        } else {
            console.log('âœ… äº‘ç«¯è¿æ¥æ­£å¸¸');
            window.useLocalMode = false;
        }
        
        // 2. æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        
        if (sessionError) {
            console.warn('è·å–ä¼šè¯å¤±è´¥:', sessionError);
        }
        
        console.log('å½“å‰ç™»å½•çŠ¶æ€:', session ? 'å·²ç™»å½•' : 'æœªç™»å½•');
        
        // 3. åŠ è½½è¯—è¯æ•°æ®
        if (session && session.user && !window.useLocalMode) {
            console.log('ğŸ“¥ ä»äº‘ç«¯åŠ è½½ç”¨æˆ·æ•°æ®...');
            await loadUserData(session.user.id);
        } else {
            console.log('ğŸ“ ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®...');
            const localData = localStorage.getItem('poem_data');
            poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
            
            // å¦‚æœæœ¬åœ°æ²¡æœ‰æ•°æ®ï¼Œä¿å­˜é»˜è®¤æ•°æ®
            if (!localData) {
                localStorage.setItem('poem_data', JSON.stringify(poems));
            }
        }
        
        // 4. æ›´æ–°UI
        updateAuthUI(session);
        renderUI();
        
        // 5. ç›‘å¬è®¤è¯çŠ¶æ€å˜åŒ–
        supabase.auth.onAuthStateChange((event, session) => {
            console.log('è®¤è¯çŠ¶æ€å˜åŒ–:', event, session);
            
            if (window.useLocalMode) {
                console.log('æœ¬åœ°æ¨¡å¼ï¼Œå¿½ç•¥è®¤è¯å˜åŒ–');
                return;
            }
            
            updateAuthUI(session);
            if (session && session.user) {
                loadUserData(session.user.id);
            } else {
                // åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼
                const localData = localStorage.getItem('poem_data');
                poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
                renderUI();
            }
        });
        
        console.log('âœ… åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        
    } catch(e) {
        console.error("âŒ åˆå§‹åŒ–å¤±è´¥:", e);
        
        // æ— è®ºå¦‚ä½•éƒ½æ¸²æŸ“é¡µé¢
        const localData = localStorage.getItem('poem_data');
        poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
        
        if (!localData) {
            localStorage.setItem('poem_data', JSON.stringify(poems));
        }
        
        renderUI();
        
        alert('åˆå§‹åŒ–è¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯ï¼Œå·²åˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼ã€‚');
    } finally {
        hideLoading();
    }
}

// ==========================================
// æ•°æ®ç®¡ç†å‡½æ•°
// ==========================================
async function loadUserData(userId) {
    if (window.useLocalMode) {
        console.log('æœ¬åœ°æ¨¡å¼ï¼Œè·³è¿‡äº‘ç«¯æ•°æ®åŠ è½½');
        return;
    }
    
    console.log('æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', userId);
    
    try {
        const { data, error } = await supabase
            .from('users')
            .select('poem_data')
            .eq('id', userId)
            .single();
            
        if (error) {
            console.log('è¯»å–ç”¨æˆ·æ•°æ®å¤±è´¥:', error);
            
            // å¦‚æœæ˜¯"è®°å½•ä¸å­˜åœ¨"é”™è¯¯ï¼Œåˆ›å»ºæ–°è®°å½•
            if (error.code === 'PGRST116') {
                console.log('ç”¨æˆ·è®°å½•ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°è®°å½•...');
                
                // è·å–ç”¨æˆ·é‚®ç®±
                const { data: userData } = await supabase.auth.getUser();
                const userEmail = userData.user.email;
                
                // åˆ›å»ºæ–°ç”¨æˆ·è®°å½•
                const { error: insertError } = await supabase
                    .from('users')
                    .insert([{
                        id: userId,
                        email: userEmail,
                        poem_data: defaultData,
                        created_at: new Date().toISOString()
                    }]);
                    
                if (insertError) {
                    console.error('åˆ›å»ºç”¨æˆ·è®°å½•å¤±è´¥:', insertError);
                    throw insertError;
                }
                
                poems = JSON.parse(JSON.stringify(defaultData));
                console.log('âœ… ç”¨æˆ·è®°å½•åˆ›å»ºæˆåŠŸ');
            } else {
                throw error;
            }
        } else {
            console.log('âœ… æˆåŠŸè¯»å–ç”¨æˆ·æ•°æ®');
            
            if (data && data.poem_data && data.poem_data.length > 0) {
                poems = data.poem_data;
                console.log('ğŸ“š åŠ è½½äº†', poems.length, 'é¦–è¯—è¯');
            } else {
                console.log('ç”¨æˆ·æ•°æ®ä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤æ•°æ®');
                poems = JSON.parse(JSON.stringify(defaultData));
                
                // æ›´æ–°ç©ºæ•°æ®
                const { error: updateError } = await supabase
                    .from('users')
                    .update({ poem_data: poems })
                    .eq('id', userId);
                    
                if (updateError) {
                    console.error('æ›´æ–°ç©ºæ•°æ®å¤±è´¥:', updateError);
                }
            }
        }
        
        // åŒæ­¥åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
        localStorage.setItem('poem_data', JSON.stringify(poems));
        
        renderUI();
        
    } catch(e) {
        console.error("âŒ åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:", e);
        
        // é™çº§ï¼šä½¿ç”¨æœ¬åœ°å­˜å‚¨
        const localData = localStorage.getItem('poem_data');
        poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
        
        if (!localData) {
            localStorage.setItem('poem_data', JSON.stringify(poems));
        }
        
        console.log('ğŸ“ ä½¿ç”¨æœ¬åœ°æ•°æ®:', poems.length, 'é¦–è¯—è¯');
        renderUI();
        
        alert('åŠ è½½äº‘ç«¯æ•°æ®å¤±è´¥ï¼Œå·²ä½¿ç”¨æœ¬åœ°å¤‡ä»½æ•°æ®ã€‚');
    }
}

async function saveUserData(userId) {
    if (window.useLocalMode) {
        console.log('æœ¬åœ°æ¨¡å¼ï¼Œä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        localStorage.setItem('poem_data', JSON.stringify(poems));
        return;
    }
    
    console.log('ğŸ’¾ ä¿å­˜ç”¨æˆ·æ•°æ®ï¼Œç”¨æˆ·ID:', userId);
    
    try {
        const { error } = await supabase
            .from('users')
            .update({ 
                poem_data: poems,
                updated_at: new Date().toISOString()
            })
            .eq('id', userId);
            
        if (error) {
            console.error('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥:', error);
            throw error;
        }
        
        console.log('âœ… äº‘ç«¯ä¿å­˜æˆåŠŸ');
        
        // åŒæ—¶ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ä½œä¸ºå¤‡ä»½
        localStorage.setItem('poem_data', JSON.stringify(poems));
        
    } catch(e) {
        console.error('âŒ ä¿å­˜ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        
        // é™çº§ï¼šä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        localStorage.setItem('poem_data', JSON.stringify(poems));
        console.log('ğŸ“ æ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨');
        
        alert('ä¿å­˜åˆ°äº‘ç«¯å¤±è´¥ï¼Œæ•°æ®å·²ä¿å­˜åˆ°æœ¬åœ°æµè§ˆå™¨ã€‚');
    }
}

// ==========================================
// è®¤è¯å‡½æ•°ï¼ˆåŒæ¨¡å¼ï¼šäº‘ç«¯ + æœ¬åœ°ï¼‰
// ==========================================
async function doRegister() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const authMsg = document.getElementById('auth-msg');
    
    authMsg.innerText = '';
    authMsg.style.color = 'red';
    
    if (!email || !password) {
        authMsg.innerText = "è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯";
        return;
    }
    
    if (password.length < 6) {
        authMsg.innerText = "å¯†ç è‡³å°‘éœ€è¦6ä½";
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    if (window.useLocalMode) {
        // æœ¬åœ°æ³¨å†Œæ¨¡å¼
        authMsg.innerText = "æ­£åœ¨æ³¨å†Œï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰...";
        
        // æ¨¡æ‹Ÿæ³¨å†Œå»¶è¿Ÿ
        setTimeout(() => {
            // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°æœ¬åœ°
            localStorage.setItem('local_user_email', email);
            localStorage.setItem('local_user_password', password);
            
            authMsg.style.color = 'green';
            authMsg.innerText = "æ³¨å†ŒæˆåŠŸï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰ï¼";
            
            // è‡ªåŠ¨ç™»å½•
            setTimeout(() => {
                doLogin();
            }, 1000);
        }, 500);
        
        return;
    }
    
    // äº‘ç«¯æ³¨å†Œæ¨¡å¼
    try {
        console.log('ğŸ“ æ­£åœ¨æ³¨å†Œç”¨æˆ·:', email);
        authMsg.innerText = "æ­£åœ¨æ³¨å†Œ...";
        
        const { data, error } = await supabase.auth.signUp({
            email,
            password,
            options: {
                data: {
                    created_at: new Date().toISOString()
                },
                emailRedirectTo: window.location.origin
            }
        });
        
        if (error) {
            console.error('æ³¨å†Œå¤±è´¥:', error);
            
            // å¦‚æœæ˜¯ç”¨æˆ·å·²å­˜åœ¨é”™è¯¯ï¼Œå°è¯•ç›´æ¥ç™»å½•
            if (error.message.includes('already registered')) {
                authMsg.innerText = "ç”¨æˆ·å·²å­˜åœ¨ï¼Œå°è¯•ç™»å½•...";
                setTimeout(() => doLogin(), 1000);
            } else {
                authMsg.innerText = error.message;
            }
            return;
        }
        
        if (data.user) {
            console.log('âœ… æ³¨å†ŒæˆåŠŸ:', data.user.email);
            authMsg.style.color = 'green';
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦é‚®ç®±ç¡®è®¤
            if (data.session) {
                authMsg.innerText = "æ³¨å†ŒæˆåŠŸï¼";
                
                // è‡ªåŠ¨å¡«å……ç™»å½•è¡¨å•å¹¶ç™»å½•
                setTimeout(() => {
                    doLogin();
                }, 1000);
            } else {
                authMsg.innerText = "æ³¨å†ŒæˆåŠŸï¼è¯·æ£€æŸ¥é‚®ç®±ç¡®è®¤ã€‚";
            }
        }
        
    } catch(e) {
        console.error("âŒ æ³¨å†Œå¤±è´¥:", e);
        
        // é™çº§åˆ°æœ¬åœ°æ¨¡å¼
        if (e.message.includes('Failed to fetch') || e.message.includes('Network')) {
            authMsg.innerText = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼...";
            window.useLocalMode = true;
            
            // é‡æ–°å°è¯•æ³¨å†Œï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰
            setTimeout(() => doRegister(), 500);
        } else {
            authMsg.innerText = "æ³¨å†Œå¤±è´¥ï¼š" + e.message;
        }
    }
}

async function doLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const authMsg = document.getElementById('auth-msg');
    
    authMsg.innerText = '';
    authMsg.style.color = 'red';
    
    if (!email || !password) {
        authMsg.innerText = "è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯";
        return;
    }
    
    // æ£€æŸ¥æ˜¯å¦ä½¿ç”¨æœ¬åœ°æ¨¡å¼
    if (window.useLocalMode) {
        // æœ¬åœ°ç™»å½•æ¨¡å¼
        authMsg.innerText = "æ­£åœ¨ç™»å½•ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰...";
        
        // æ¨¡æ‹Ÿç™»å½•å»¶è¿Ÿ
        setTimeout(() => {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯
            const savedEmail = localStorage.getItem('local_user_email');
            const savedPassword = localStorage.getItem('local_user_password');
            
            if (email === savedEmail && password === savedPassword) {
                authMsg.style.color = 'green';
                authMsg.innerText = "ç™»å½•æˆåŠŸï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰ï¼";
                
                // å…³é—­å¼¹çª—
                setTimeout(() => {
                    closeModal('auth-modal');
                    
                    // æ›´æ–°UIæ˜¾ç¤ºæœ¬åœ°ç”¨æˆ·
                    updateAuthUI({ user: { email } });
                    
                    // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                    alert(`æ¬¢è¿ï¼Œ${email.split('@')[0]}ï¼æ•°æ®å°†ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚`);
                }, 1000);
            } else {
                authMsg.innerText = "é‚®ç®±æˆ–å¯†ç é”™è¯¯";
            }
        }, 500);
        
        return;
    }
    
    // äº‘ç«¯ç™»å½•æ¨¡å¼
    try {
        console.log('ğŸ” æ­£åœ¨ç™»å½•:', email);
        authMsg.innerText = "æ­£åœ¨ç™»å½•...";
        
        const { data, error } = await supabase.auth.signInWithPassword({
            email,
            password
        });
        
        if (error) {
            console.error('ç™»å½•å¤±è´¥:', error);
            
            // å¦‚æœæ˜¯å‡­è¯é”™è¯¯ï¼Œæ£€æŸ¥æ˜¯å¦è¦åˆ›å»ºæ–°ç”¨æˆ·
            if (error.message.includes('Invalid login credentials')) {
                if (confirm("ç”¨æˆ·ä¸å­˜åœ¨ï¼Œæ˜¯å¦è¦æ³¨å†Œæ–°è´¦å·ï¼Ÿ")) {
                    doRegister();
                } else {
                    authMsg.innerText = "é‚®ç®±æˆ–å¯†ç é”™è¯¯";
                }
            } else {
                authMsg.innerText = error.message;
            }
            return;
        }
        
        if (data.user) {
            console.log('âœ… ç™»å½•æˆåŠŸ:', data.user.email);
            authMsg.style.color = 'green';
            authMsg.innerText = "ç™»å½•æˆåŠŸï¼";
            
            // å…³é—­å¼¹çª—
            setTimeout(() => {
                closeModal('auth-modal');
                
                // åŠ è½½ç”¨æˆ·æ•°æ®
                loadUserData(data.user.id);
                
                // æ˜¾ç¤ºæ¬¢è¿æ¶ˆæ¯
                alert(`æ¬¢è¿å›æ¥ï¼Œ${data.user.email.split('@')[0]}ï¼`);
            }, 1000);
        }
        
    } catch(e) {
        console.error("âŒ ç™»å½•å¤±è´¥:", e);
        
        // é™çº§åˆ°æœ¬åœ°æ¨¡å¼
        if (e.message.includes('Failed to fetch') || e.message.includes('Network')) {
            authMsg.innerText = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œåˆ‡æ¢åˆ°æœ¬åœ°æ¨¡å¼...";
            window.useLocalMode = true;
            
            // æ£€æŸ¥æœ¬åœ°æ˜¯å¦æœ‰è¯¥ç”¨æˆ·
            const savedEmail = localStorage.getItem('local_user_email');
            const savedPassword = localStorage.getItem('local_user_password');
            
            if (email === savedEmail && password === savedPassword) {
                setTimeout(() => doLogin(), 500);
            } else {
                authMsg.innerText = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æœ¬åœ°ç”¨æˆ·æˆ–æ³¨å†Œæ–°ç”¨æˆ·";
            }
        } else {
            authMsg.innerText = "ç™»å½•å¤±è´¥ï¼š" + e.message;
        }
    }
}

async function doLogout() {
    if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
        try {
            // å…ˆä¿å­˜å½“å‰æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
            if (!window.useLocalMode) {
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    await saveUserData(session.user.id);
                }
                
                // é€€å‡ºç™»å½•ï¼ˆäº‘ç«¯ï¼‰
                const { error } = await supabase.auth.signOut();
                if (error) {
                    console.error("é€€å‡ºç™»å½•å¤±è´¥:", error);
                }
            }
            
            // æ¸…é™¤æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
            localStorage.removeItem('local_user_email');
            localStorage.removeItem('local_user_password');
            
            console.log('é€€å‡ºç™»å½•æˆåŠŸ');
            
            // åˆ‡æ¢åˆ°æœ¬åœ°è®¿å®¢æ¨¡å¼
            const localData = localStorage.getItem('poem_data');
            poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
            
            if (!localData) {
                localStorage.setItem('poem_data', JSON.stringify(poems));
            }
            
            renderUI();
            
        } catch(e) {
            console.error("é€€å‡ºç™»å½•å¤±è´¥:", e);
            alert("é€€å‡ºç™»å½•å¤±è´¥: " + e.message);
        }
    }
}

// ==========================================
// æ›´æ–°è®¤è¯UI
// ==========================================
function updateAuthUI(session) {
    console.log('æ›´æ–°è®¤è¯UIï¼Œä¼šè¯:', session);
    
    const nameEl = document.getElementById('user-name');
    const dot = document.getElementById('status-dot');
    const authWidget = document.querySelector('.auth-widget');
    
    if (window.useLocalMode) {
        // æœ¬åœ°æ¨¡å¼ï¼šæ£€æŸ¥æœ¬åœ°ç”¨æˆ·
        const localEmail = localStorage.getItem('local_user_email');
        
        if (localEmail) {
            const displayName = localEmail.split('@')[0];
            nameEl.innerText = displayName + ' (æœ¬åœ°)';
            dot.className = 'status-dot online';
            
            // æ›´æ–°ç™»å½•æ¡
            authWidget.innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span class="status-dot online"></span>
                    <span style="font-weight:600; color:#374151;">${displayName} (æœ¬åœ°)</span>
                </div>
                <button class="btn-text" onclick="doLogout()" style="font-size:12px;">é€€å‡º</button>
            `;
            return;
        }
    }
    
    if (session && session.user) {
        // äº‘ç«¯ç”¨æˆ·å·²ç™»å½•
        const displayName = session.user.email.split('@')[0];
        nameEl.innerText = displayName;
        dot.className = 'status-dot online';
        
        // æ›´æ–°ç™»å½•æ¡
        authWidget.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="status-dot online"></span>
                <span style="font-weight:600; color:#374151;">${displayName}</span>
            </div>
            <button class="btn-text" onclick="doLogout()" style="font-size:12px;">é€€å‡º</button>
        `;
    } else {
        // æœªç™»å½•
        nameEl.innerText = 'æœ¬åœ°è®¿å®¢';
        dot.className = 'status-dot';
        
        // æ¢å¤ç™»å½•æ¡
        authWidget.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="status-dot"></span>
                <span style="font-weight:600; color:#374151;">æœ¬åœ°è®¿å®¢</span>
            </div>
            <button class="btn-text" onclick="showAuth()" style="font-size:12px;">ç™»å½•/æ³¨å†Œ</button>
        `;
    }
}

// ==========================================
// è¾…åŠ©å‡½æ•°
// ==========================================
function showLoading(message) {
    // åˆ›å»ºåŠ è½½é®ç½©
    let loadingDiv = document.getElementById('loading-overlay');
    if (!loadingDiv) {
        loadingDiv = document.createElement('div');
        loadingDiv.id = 'loading-overlay';
        loadingDiv.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            color: white;
            font-size: 18px;
        `;
        document.body.appendChild(loadingDiv);
    }
    
    loadingDiv.innerHTML = `
        <div style="text-align: center; background: white; padding: 30px; border-radius: 10px; color: #333;">
            <div style="margin-bottom: 15px;">â³ ${message}</div>
            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #059669; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
        </div>
    `;
}

function hideLoading() {
    const loadingDiv = document.getElementById('loading-overlay');
    if (loadingDiv) {
        loadingDiv.remove();
    }
}

// ==========================================
// åˆå§‹åŒ–
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ DOM åŠ è½½å®Œæˆ');
    
    // æ·»åŠ  spin åŠ¨ç”»æ ·å¼
    const style = document.createElement('style');
    style.textContent = `
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    `;
    document.head.appendChild(style);
    
    // åˆå§‹åŒ–åº”ç”¨
    init();
    
    // æ·»åŠ è°ƒè¯•å‘½ä»¤åˆ°å…¨å±€
    window.debugMode = function() {
        console.log('=== è°ƒè¯•ä¿¡æ¯ ===');
        console.log('ä½¿ç”¨æœ¬åœ°æ¨¡å¼:', window.useLocalMode);
        console.log('è¯—è¯æ•°é‡:', poems.length);
        console.log('Supabase URL:', supabaseUrl);
        console.log('æœ¬åœ°ç”¨æˆ·:', localStorage.getItem('local_user_email'));
        
        // æµ‹è¯•è¿æ¥
        testSupabaseConnection();
    };
    
    console.log('ğŸ® è°ƒè¯•å‘½ä»¤å¯ç”¨: debugMode()');
});
</script>
