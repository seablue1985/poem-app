<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- ğŸ“± PWA æ ¸å¿ƒé…ç½® -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#e0f2f1"> <!-- è¿™é‡Œçš„é¢œè‰²è¦å’Œæ‚¨çš„èƒŒæ™¯è‰²ä¸€è‡´ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655562.png"> <!-- è¿™é‡Œå¯ä»¥æ¢æˆæ‚¨å–œæ¬¢çš„å›¾æ ‡é“¾æ¥ -->
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3655/3655562.png">
<!-- æ·»åŠ åˆ° head ä¸­ -->
<link rel="manifest" href="/manifest.json">
<meta name="apple-mobile-web-app-title" content="å¤è¯—é›…é›†">
<meta name="application-name" content="å¤è¯—é›…é›†">

<style>
    /* ğŸ“± é’ˆå¯¹æ‰‹æœº App æ¨¡å¼çš„é¢å¤–ä¼˜åŒ– */
    @media (max-width: 768px) {
        body { padding-bottom: 40px; } /* é˜²æ­¢åº•éƒ¨è¢«æ‰‹æœºæ¨ªæ¡æŒ¡ä½ */
        .app-container { padding: 10px; gap: 15px; height: auto; }
        .sidebar, .main-content { border-radius: 15px; padding: 15px; }
        /* è®©æ‰‹æœºä¸Šå­—ä½“ç¨å¾®å¤§ä¸€ç‚¹ */
        .task-card h4 { font-size: 18px; }
        .poem-card b { font-size: 18px; }
    }
</style>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤è¯—Â·äº‘ç«¯é›…é›†</title>
    <style>
        :root {
            /* ğŸŸ¢ æ ¸å¿ƒé…è‰²ï¼šæ¸…æ–°æŠ¤çœ¼ç»¿ */
            --bg-gradient: linear-gradient(135deg, #e0f2f1 0%, #a7f3d0 100%); /* æ™¨é›¾ç»¿æ¸å˜ */
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --primary: #059669;    /* ç¿¡ç¿ ç»¿ - ä¸»æŒ‰é’®/é‡ç‚¹ */
            --primary-dark: #047857;
            --secondary: #34d399;  /* å«©èŠ½ç»¿ - è£…é¥° */
            --text-main: #1f2937;  /* æ·±ç° - æ­£æ–‡ */
            --text-sub: #4b5563;   /* æµ…ç° - è¾…åŠ©æ–‡å­— */
            --accent-red: #ef4444; /* é€¾æœŸ/é”™è¯¯ */
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body {
            background: var(--bg-gradient);
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* === å¸ƒå±€å®¹å™¨ === */
        .app-container {
            max-width: 1600px; /* å®½å±é€‚é… */
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr; /* å·¦ä¾§å›ºå®š320pxï¼Œå³ä¾§è‡ªé€‚åº” */
            gap: 25px;
            height: 95vh;
        }

        /* === å…¬å…±å¡ç‰‡æ ·å¼ (æ¯›ç»ç’ƒ) === */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        /* === å·¦ä¾§è¾¹æ  (ä¿¡æ¯æµ) === */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .brand-area h1 {
            font-size: 24px;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ç™»å½•æ¡ */
        .auth-widget {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; display: inline-block; }
        .status-dot.online { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        /* ç»Ÿè®¡å— */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-num { font-size: 24px; font-weight: 800; color: var(--primary); display: block; }
        .stat-desc { font-size: 12px; color: var(--text-sub); }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .task-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border-left: 5px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }
        .task-card:hover { transform: translateX(5px); }
        .task-card.new { border-left-color: var(--primary); }
        .task-card.review { border-left-color: #10b981; }
        .task-card.overdue { border-left-color: var(--accent-red); }
        .task-card h4 { margin: 0 0 5px 0; font-size: 16px; }
        
        /* æ ‡ç­¾ */
        .badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 4px;
        }
        .bg-new { background: var(--primary); }
        .bg-rev { background: #10b981; }
        .bg-ovd { background: var(--accent-red); }

        /* === å³ä¾§ä¸»åŒºåŸŸ (ä¹¦åº“) === */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow: hidden; /* é˜²æ­¢æ’‘å¼€é¡µé¢ */
        }

        .toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            outline: none;
            transition: box-shadow 0.3s;
        }
        .search-bar:focus { box-shadow: 0 4px 20px rgba(5, 150, 105, 0.15); }

        .btn-icon {
            width: 46px; height: 46px;
            border-radius: 12px;
            border: none;
            background: white;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-icon:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        /* è¯—è¯ç½‘æ ¼ (è‡ªé€‚åº”å®½å±) */
        .library-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 5px; /* é˜²æ­¢é˜´å½±è¢«åˆ‡ */
        }
        .poem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* å®½å±è‡ªé€‚åº”åˆ—æ•° */
            gap: 15px;
        }
        
        .poem-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
        }
        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.1);
            border-color: var(--secondary);
        }
        .poem-card b { display: block; font-size: 18px; margin-bottom: 5px; color: var(--text-main); }
        .poem-card small { color: #888; font-size: 13px; }
        .poem-card.learned { opacity: 0.6; background: #f9fafb; }
        .poem-card.learned::after {
            content: "âœ…"; position: absolute; top: 10px; right: 10px; font-size: 12px;
        }

        /* === æŒ‰é’®é€šç”¨ === */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-text { background: none; color: var(--primary); }
        
        /* === å¼¹çª—æ ·å¼ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-card {
            background: white;
            width: 500px;
            max-width: 90%;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .poem-content-display {
            font-family: "KaiTi", "STKaiti", "æ¥·ä½“", serif;
            font-size: 26px;
            line-height: 1.8;
            background: #f0fdf4;
            padding: 25px;
            border-radius: 16px;
            margin: 20px 0;
            color: #064e3b;
            white-space: pre-wrap;
            border: 1px dashed #6ee7b7;
        }

        /* è¾“å…¥æ¡†ç¾åŒ– */
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-top: 5px; box-sizing: border-box; }

        /* å“åº”å¼ï¼šæ‰‹æœºç«¯å˜ä¸ºå•åˆ— */
        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; height: auto; padding: 15px; }
            .sidebar { height: auto; overflow: visible; }
            .main-content { height: auto; }
            .library-scroll { overflow: visible; }
            .poem-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 2000; }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <div class="app-container">
        <!-- å·¦ä¾§è¾¹æ ï¼šçŠ¶æ€ä¸ä»»åŠ¡ -->
        <aside class="sidebar glass-card">
            <div class="brand-area">
                <h1>ğŸƒ å¤è¯—Â·äº‘ç«¯é›…é›†</h1>
                <p style="font-size:12px; color:#666; margin-top:5px;">è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ Â· æ™ºèƒ½è§„åˆ’</p>
            </div>

            <!-- ç™»å½•çŠ¶æ€ -->
            <div class="auth-widget">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="user-name" style="font-weight:600; color:#374151;">æœ¬åœ°è®¿å®¢</span>
                </div>
                <button class="btn-text" onclick="showAuth()" style="font-size:12px;">åˆ‡æ¢è´¦å·</button>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="stats-row">
                <div class="stat-box">
                    <span class="stat-num" id="count-todo">0</span>
                    <span class="stat-desc">ä»Šæ—¥å¾…åŠ</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="count-done">0</span>
                    <span class="stat-desc">å·²ç†ŸèƒŒ</span>
                </div>
            </div>

            <!-- ä»Šæ—¥ä»»åŠ¡ -->
            <div>
                <h3 style="margin-bottom:15px; color:#374151; display:flex; justify-content:space-between; align-items:center;">
                    ğŸ“… ä»Šæ—¥ä»»åŠ¡
                    <span style="font-size:12px; font-weight:normal; color:#888;">ç‚¹æ­¤å¼€å§‹èƒŒè¯µ</span>
                </h3>
                <div id="task-list" class="task-list">
                    <!-- ä»»åŠ¡å¡ç‰‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸï¼šè—ä¹¦é˜ -->
        <main class="main-content glass-card">
            <div class="toolbar">
                <input type="text" id="search" class="search-bar" placeholder="ğŸ” æœç´¢è¯—è¯åº“ (å¦‚ï¼šæç™½ã€æ˜¥æ™“)..." oninput="renderUI()">
                <button class="btn-icon" onclick="showImport()" title="å¯¼å…¥æ–°è¯—">â•</button>
                <button class="btn-icon" onclick="resetAll()" title="æ¸…ç©ºé‡ç½®" style="color:var(--accent-red)">â†»</button>
            </div>

            <h3 style="margin:10px 0; color:#374151;">ğŸ“š è—ä¹¦é˜ (ç‚¹å‡»å¡ç‰‡å­¦ä¹ )</h3>
            
            <div class="library-scroll">
                <div id="lib-grid" class="poem-grid">
                    <!-- è¯—è¯å¡ç‰‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </main>
    </div>

    <!-- å¼¹çª—ï¼šç™»å½• -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-card">
            <h2>â˜ï¸ äº‘ç«¯åŒæ­¥</h2>
            <p style="color:#666; font-size:14px;">ç™»å½•åï¼Œæ‚¨çš„èƒŒè¯µè¿›åº¦å°†åœ¨æ‰€æœ‰è®¾å¤‡é—´è‡ªåŠ¨åŒæ­¥ã€‚</p>
            <div class="input-group">
                <input type="text" id="email" class="input-field" placeholder="è¯·è¾“å…¥é‚®ç®±æˆ–ç”¨æˆ·å">
                <input type="password" id="password" class="input-field" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="doLogin()">ç™»å½•å¹¶åŒæ­¥</button>
            <button class="btn btn-text" style="width:100%; margin-top:10px;" onclick="doRegister()">æ³¨å†Œæ–°è´¦å·</button>
            <div id="auth-msg" style="color:red; margin-top:10px; font-size:12px;"></div>
            <button class="btn-text" onclick="closeModal('auth-modal')" style="position:absolute; top:15px; right:15px; font-size:20px;">Ã—</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šèƒŒè¯µç•Œé¢ -->
    <div id="study-modal" class="modal-overlay">
        <div class="modal-card" style="width:600px;">
            <span id="study-tag" class="badge bg-new" style="font-size:12px; padding:4px 10px;">æ–°å­¦</span>
            <h2 id="s-title" style="margin:10px 0; font-size:28px; color:#064e3b;"></h2>
            <div id="s-author" style="color:#6b7280; font-weight:500;"></div>
            
            <div id="s-text" class="poem-content-display"></div>
            
            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="btn" style="background:#f3f4f6; color:#666; flex:1;" onclick="closeModal('study-modal')">ç¨åå¤ä¹ </button>
                <button class="btn btn-primary" style="flex:2; font-size:16px;" onclick="finishTask()">âœ… æˆ‘èƒŒä¸‹æ¥äº†</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¯¼å…¥ -->
    <div id="import-modal" class="modal-overlay">
        <div class="modal-card">
            <h3>æ‰¹é‡å¯¼å…¥è¯—è¯</h3>
            
            <!-- æ ¼å¼é€‰æ‹©å™¨ -->
            <div class="input-group">
                <label style="font-size:14px;">å¯¼å…¥æ ¼å¼:</label>
                <select id="import-format" class="input-field">
                    <option value="pipe">æ ‡é¢˜|ä½œè€…|å†…å®¹ (ä¸€è¡Œä¸€é¦–)</option>
                    <option value="json">JSONæ ¼å¼</option>
                    <option value="plain">æ™®é€šæ–‡æœ¬ (æ ‡é¢˜\nä½œè€…\nå†…å®¹\nç©ºè¡Œåˆ†éš”)</option>
                </select>
            </div>
            
            <!-- æ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
            <div class="input-group">
                <label style="font-size:14px;">è¾“å…¥å†…å®¹:</label>
                <textarea id="import-txt" class="input-field" style="height:120px;" placeholder="æ ¹æ®æ‰€é€‰æ ¼å¼è¾“å…¥å†…å®¹"></textarea>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="input-group">
                <label style="font-size:14px;">æˆ–ä»æ–‡ä»¶å¯¼å…¥:</label>
                <input type="file" id="import-file" class="input-field" accept=".txt,.json" 
                       style="padding:8px;" onchange="handleFileImport(event)">
            </div>
            
            <!-- å¯¼å…¥é€‰é¡¹ -->
            <div class="input-group">
                <label>
                    <input type="checkbox" id="skip-duplicates" checked> è·³è¿‡é‡å¤è¯—è¯
                </label>
                <label style="margin-left:15px;">
                    <input type="checkbox" id="overwrite-existing"> è¦†ç›–é‡å¤è¯—è¯
                </label>
            </div>
            
            <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
            <div id="import-errors" style="color:var(--accent-red); margin:10px 0; font-size:13px; max-height:100px; overflow-y:auto;"></div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="doImport()">ç¡®è®¤å¯¼å…¥</button>
            <button class="btn-text" onclick="closeModal('import-modal')" style="position:absolute; top:15px; right:15px; font-size:20px;">Ã—</button>
        </div>
    </div>

    <script>
        // ==========================================
        const API_URL = "https://poemreciter.337968914.workers.dev"; 
        // ==========================================
        // å¯†ç åŠ å¯†å‡½æ•°ï¼ˆä½¿ç”¨ bcrypt æ›¿ä»£æ–¹æ¡ˆï¼‰
        async function hashPassword(password) {
        // å®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„åŠ å¯†æ–¹å¼
        // è¿™é‡Œä½¿ç”¨ç®€å•çš„ SHA-256 ä½œä¸ºç¤ºä¾‹
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'your_salt_here'); // æ·»åŠ ç›å€¼
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            }
        const defaultData = [
            {id:1,title:"æ±Ÿå—",author:"æ±‰ä¹åºœ",content:"æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ã€‚\né±¼æˆè²å¶é—´ã€‚\né±¼æˆè²å¶ä¸œï¼Œé±¼æˆè²å¶è¥¿ï¼Œ\né±¼æˆè²å¶å—ï¼Œé±¼æˆè²å¶åŒ—ã€‚"},
            {id:2,title:"å’é¹…",author:"éª†å®¾ç‹",content:"é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œæ›²é¡¹å‘å¤©æ­Œã€‚\nç™½æ¯›æµ®ç»¿æ°´ï¼Œçº¢æŒæ‹¨æ¸…æ³¢ã€‚"},
            {id:3,title:"æ˜¥æ™“",author:"å­Ÿæµ©ç„¶",content:"æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚"},
            {id:4,title:"é™å¤œæ€",author:"æç™½",content:"åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚"},
            {id:5,title:"é£",author:"æå³¤",content:"è§£è½ä¸‰ç§‹å¶ï¼Œèƒ½å¼€äºŒæœˆèŠ±ã€‚\nè¿‡æ±Ÿåƒå°ºæµªï¼Œå…¥ç«¹ä¸‡ç«¿æ–œã€‚"},
            {id:6,title:"å’æŸ³",author:"è´ºçŸ¥ç« ",content:"ç¢§ç‰å¦†æˆä¸€æ ‘é«˜ï¼Œä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦ã€‚\nä¸çŸ¥ç»†å¶è°è£å‡ºï¼ŒäºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€ã€‚"}
        ];

        let poems = [];
        let userInfo = JSON.parse(localStorage.getItem('cf_user') || 'null');
        let curId=null, curType=null, curRevIdx=null;

        async function init() {
            try {
                const localData = localStorage.getItem('poem_data');
                poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
                updateAuthUI();
                if(userInfo) {
                    try {
                        await syncData(true);
                    } catch(e) {
                        console.log("åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:", e.message);
                    }
                }
                renderUI();
            } catch(e) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", e);
                // æ— è®ºå¦‚ä½•æ¸²æŸ“é¡µé¢
                renderUI();
      <script>

        // ==========================================
        // ğŸŸ¢ 1. åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ (è¿™æ˜¯å”¯ä¸€æœ‰æ•ˆçš„åç«¯)
        // ==========================================
        const supabaseUrl = 'https://ntrrijirsqluulvpgxoj.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im50cnJpamlyc3FsdXVsdnBneG9qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5MDE0MjksImV4cCI6MjA4MDQ3NzQyOX0.9XQRR95lQANH59zQ1ZlvGqrZX2lUy5EDJLspscLUuqY';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
        // ==========================================

        const defaultData = [
            {id:1,title:"æ±Ÿå—",author:"æ±‰ä¹åºœ",content:"æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ã€‚\né±¼æˆè²å¶é—´ã€‚\né±¼æˆè²å¶ä¸œï¼Œé±¼æˆè²å¶è¥¿ï¼Œ\né±¼æˆè²å¶å—ï¼Œé±¼æˆè²å¶åŒ—ã€‚"},
            {id:2,title:"å’é¹…",author:"éª†å®¾ç‹",content:"é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œæ›²é¡¹å‘å¤©æ­Œã€‚\nç™½æ¯›æµ®ç»¿æ°´ï¼Œçº¢æŒæ‹¨æ¸…æ³¢ã€‚"},
            {id:3,title:"æ˜¥æ™“",author:"å­Ÿæµ©ç„¶",content:"æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚"},
            {id:4,title:"é™å¤œæ€",author:"æç™½",content:"åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚"},
            {id:5,title:"é£",author:"æå³¤",content:"è§£è½ä¸‰ç§‹å¶ï¼Œèƒ½å¼€äºŒæœˆèŠ±ã€‚\nè¿‡æ±Ÿåƒå°ºæµªï¼Œå…¥ç«¹ä¸‡ç«¿æ–œã€‚"},
            {id:6,title:"å’æŸ³",author:"è´ºçŸ¥ç« ",content:"ç¢§ç‰å¦†æˆä¸€æ ‘é«˜ï¼Œä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦ã€‚\nä¸çŸ¥ç»†å¶è°è£å‡ºï¼ŒäºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€ã€‚"}
        ];

        let poems = [];
        let userInfo = JSON.parse(localStorage.getItem('cf_user') || 'null');
        let curId=null, curType=null, curRevIdx=null;

        // --- æ ¸å¿ƒï¼šç»Ÿä¸€ä½¿ç”¨ Supabase çš„ apiCall å‡½æ•° ---
       async function apiCall(endpoint, payload) {
  try {
    // æ³¨å†Œ
    if (endpoint === '/register') {
      const { email, password, initialData } = payload;
      
      // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨
      const { data: existingUser, error: checkError } = await supabase
        .from('users')
        .select('email')
        .eq('email', email)
        .single();
      
      if (existingUser) {
        return { success: false, error: 'è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ' };
      }
      
      const hashedPassword = await hashPassword(password);
      const { data, error } = await supabase
        .from('users')
        .insert([{
          email,
          password_hash: hashedPassword,
          poem_data: initialData || []
        }])
        .select();
      
      return error ? { success: false, error: error.message } : { success: true, data };
    }
    
    // ç™»å½•
    if (endpoint === '/login') {
      const { email, password } = payload;
      const hashedPassword = await hashPassword(password);
      
      const { data, error } = await supabase
        .from('users')
        .select('*')
        .eq('email', email)
        .eq('password_hash', hashedPassword)
        .single();
      
      if (error || !data) {
        return { success: false, error: 'é‚®ç®±æˆ–å¯†ç é”™è¯¯' };
      }
      
      return { success: true, data: data.poem_data || [] };
    }
    
    // åŒæ­¥æ•°æ®
    if (endpoint === '/sync') {
      const { email, password, data: syncData } = payload;
      const hashedPassword = await hashPassword(password);
      
      // éªŒè¯ç”¨æˆ·
      const { data: user, error: authError } = await supabase
        .from('users')
        .select('id')
        .eq('email', email)
        .eq('password_hash', hashedPassword)
        .single();
      
      if (authError || !user) {
        return { success: false, error: 'è®¤è¯å¤±è´¥' };
      }
      
      // æ›´æ–°æ•°æ®
      const { error: updateError } = await supabase
        .from('users')
        .update({ poem_data: syncData })
        .eq('id', user.id);
      
      return updateError ? 
        { success: false, error: updateError.message } : 
        { success: true };
    }
    
    return { success: false, error: 'æœªçŸ¥çš„APIç«¯ç‚¹' };
    
  } catch(e) {
    console.error('APIè°ƒç”¨é”™è¯¯:', e);
    return { success: false, error: 'ç½‘ç»œé”™è¯¯: ' + e.message };
  }
}

        // --- ç”¨æˆ·æ“ä½œå‡½æ•° (å®ƒä»¬ç°åœ¨ä¼šè°ƒç”¨ç»Ÿä¸€çš„ Supabase apiCall) ---
        async function doRegister() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            if(!email || !password) {
                document.getElementById('auth-msg').innerText = 'è¯·è¾“å…¥é‚®ç®±å’Œå¯†ç ';
                return;
            }
            const res = await apiCall('/register', { email, password, initialData: poems });
            if(res.success) {
                alert("æ³¨å†ŒæˆåŠŸï¼æ‚¨ç°åœ¨å¯ä»¥ç™»å½•äº†ã€‚");
                // æ¸…ç©ºå¯†ç æ¡†ï¼Œæ–¹ä¾¿ç”¨æˆ·ç›´æ¥ç™»å½•
                document.getElementById('password').value = '';
            } else {
                document.getElementById('auth-msg').innerText = res.error || 'æ³¨å†Œå¤±è´¥';
            }
        }

        async function doLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const res = await apiCall('/login', { email, password });
            if(res.success) {
                userInfo = { email, password };
                localStorage.setItem('cf_user', JSON.stringify(userInfo));
                if(res.data && res.data.length > 0) {
                    poems = res.data;
                    saveLocal();
                }
                updateAuthUI();
                closeModal('auth-modal');
                renderUI();
                alert("ç™»å½•æˆåŠŸï¼æ•°æ®å·²åŒæ­¥ã€‚");
            } else {
                document.getElementById('auth-msg').innerText = res.error || 'ç™»å½•å¤±è´¥';
            }
        }

        async function syncData(silent = false) {
            if(!userInfo) return;
            const res = await apiCall('/sync', { ...userInfo, data: poems });
            if(!res.success && !silent) {
                alert("äº‘ç«¯åŒæ­¥å¤±è´¥: " + res.error);
            } else if (res.success && !silent) {
                console.log('äº‘ç«¯åŒæ­¥æˆåŠŸ');
            }
        }

        function doLogout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼ŸæœªåŒæ­¥çš„æ•°æ®å¯èƒ½ä¸¢å¤±ã€‚")) {
                userInfo = null;
                localStorage.removeItem('cf_user');
                updateAuthUI();
                renderUI();
            }
        }

        // --- ä»¥ä¸‹ä¸ºåŸæœ‰åŠŸèƒ½å‡½æ•°ï¼Œæ— éœ€ä¿®æ”¹ä½†éœ€ç¡®ä¿å­˜åœ¨ ---
        function saveLocal() { localStorage.setItem('poem_data', JSON.stringify(poems)); }
        function renderUI() { /* æ‚¨åŸæœ‰çš„æ¸²æŸ“å‡½æ•° */ }
        function showStudy(id, type, idx) { /* æ‚¨åŸæœ‰çš„å­¦ä¹ å‡½æ•° */ }
        async function finishTask() {
            // ... æ‚¨åŸæœ‰çš„å®Œæˆä»»åŠ¡é€»è¾‘
            if(userInfo) await syncData(true); // å®Œæˆä»»åŠ¡åé™é»˜åŒæ­¥
        }
        function updateAuthUI() {
            const nameEl = document.getElementById('user-name');
            const dot = document.getElementById('status-dot');
            if(userInfo) {
                nameEl.innerText = userInfo.email.split('@')[0];
                dot.className = 'status-dot online';
            } else {
                nameEl.innerText = 'æœ¬åœ°è®¿å®¢';
                dot.className = 'status-dot';
            }
        }

        // --- è¾…åŠ©ä¸å·¥å…·å‡½æ•° (ä¿æŒåŸæœ‰) ---
        function showAuth() { document.getElementById('auth-modal').style.display='flex'; }
        function showImport() { document.getElementById('import-modal').style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function resetAll() {
            if(confirm("ç¡®å®šæ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å¹¶é‡ç½®ï¼Ÿè¿™ä¸ä¼šåˆ é™¤äº‘ç«¯è´¦æˆ·ã€‚")) {
                localStorage.removeItem('poem_data');
                localStorage.removeItem('cf_user');
                location.reload();
            }
        }
        function fireConfetti() { /* æ‚¨åŸæœ‰çš„åº†ç¥åŠ¨ç”» */ }

        // --- å¯¼å…¥/å¯¼å‡ºç›¸å…³å‡½æ•° (ä¿æŒåŸæœ‰) ---
        function handleFileImport(event) { /* åŸæœ‰å‡½æ•° */ }
        function doImport() { /* åŸæœ‰å‡½æ•°ï¼Œè°ƒç”¨åå¯ä»¥è€ƒè™‘è§¦å‘åŒæ­¥ */ }
        function parsePipeFormat(input) { /* åŸæœ‰å‡½æ•° */ }
        function parseJsonFormat(input) { /* åŸæœ‰å‡½æ•° */ }
        function parsePlainTextFormat(input) { /* åŸæœ‰å‡½æ•° */ }

        // åˆå§‹åŒ–åº”ç”¨
        init();
    </script>
