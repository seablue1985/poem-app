<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
// ==========================================
// Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–
// ==========================================
let supabase;
let supabaseUrl = 'https://ntrrijirsqluulvpgxoj.supabase.co';
let supabaseKey = 'sb_publishable_ttBOGdcAgCZSExC3Yitx0w_oSFN6P18';

try {
    supabase = window.supabase.createClient(supabaseUrl, supabaseKey, {
        auth: {
            autoRefreshToken: true,
            persistSession: true,
            detectSessionInUrl: true,
            storage: window.localStorage
        }
    });
    console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸ');
} catch (error) {
    console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', error);
    alert('åˆå§‹åŒ–å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼');
}

// ==========================================
// å…¨å±€å˜é‡
// ==========================================
const defaultData = [
    {id:1,title:"æ±Ÿå—",author:"æ±‰ä¹åºœ",content:"æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ã€‚\né±¼æˆè²å¶é—´ã€‚\né±¼æˆè²å¶ä¸œï¼Œé±¼æˆè²å¶è¥¿ï¼Œ\né±¼æˆè²å¶å—ï¼Œé±¼æˆè²å¶åŒ—ã€‚"},
    {id:2,title:"å’é¹…",author:"éª†å®¾ç‹",content:"é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œæ›²é¡¹å‘å¤©æ­Œã€‚\nç™½æ¯›æµ®ç»¿æ°´ï¼Œçº¢æŒæ‹¨æ¸…æ³¢ã€‚"},
    {id:3,title:"æ˜¥æ™“",author:"å­Ÿæµ©ç„¶",content:"æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚"},
    {id:4,title:"é™å¤œæ€",author:"æç™½",content:"åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚"},
    {id:5,title:"é£",author:"æå³¤",content:"è§£è½ä¸‰ç§‹å¶ï¼Œèƒ½å¼€äºŒæœˆèŠ±ã€‚\nè¿‡æ±Ÿåƒå°ºæµªï¼Œå…¥ç«¹ä¸‡ç«¿æ–œã€‚"},
    {id:6,title:"å’æŸ³",author:"è´ºçŸ¥ç« ",content:"ç¢§ç‰å¦†æˆä¸€æ ‘é«˜ï¼Œä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦ã€‚\nä¸çŸ¥ç»†å¶è°è£å‡ºï¼ŒäºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€ã€‚"}
];

let poems = [];
let curId=null, curType=null, curRevIdx=null;

// ==========================================
// åˆå§‹åŒ–å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ==========================================
async function init() {
    console.log('ğŸš€ å¼€å§‹åˆå§‹åŒ–...');
    
    try {
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®
        const localData = localStorage.getItem('poem_data');
        poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
        
        // æ£€æŸ¥ Supabase æ˜¯å¦å¯ç”¨
        if (!supabase) {
            console.log('åˆ‡æ¢åˆ°çº¯æœ¬åœ°æ¨¡å¼...');
            window.useLocalMode = true;
        } else {
            // æ£€æŸ¥ç”¨æˆ·ç™»å½•çŠ¶æ€
            const { data: { session }, error } = await supabase.auth.getSession();
            if (!error && session) {
                console.log('ç”¨æˆ·å·²ç™»å½•:', session.user.email);
                window.useLocalMode = false;
                await loadUserData(session.user.id);
            } else {
                window.useLocalMode = true;
            }
        }
        
        // æ›´æ–°UI
        updateAuthUI();
        renderUI();
        
    } catch(e) {
        console.error("åˆå§‹åŒ–å¤±è´¥:", e);
        // é™çº§ï¼šä½¿ç”¨æœ¬åœ°æ•°æ®
        const localData = localStorage.getItem('poem_data');
        poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
        renderUI();
    }
}

// ==========================================
// åŸºæœ¬åŠŸèƒ½å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ==========================================
function renderUI() {
    const list = document.getElementById('task-list');
    const grid = document.getElementById('lib-grid');
    const kw = document.getElementById('search')?.value.toLowerCase() || '';
    list.innerHTML = ''; grid.innerHTML = '';
    
    let todo=0, done=0;
    const today = new Date().setHours(0,0,0,0);
    const intervals = [1,2,4,7,15,30];

    // æ’åºï¼šæœªå­¦çš„æŒ‰IDæ’ï¼Œå·²å­¦çš„é å
    const sortedPoems = [...poems].sort((a,b) => (a.id - b.id));

    sortedPoems.forEach(p => {
        if(kw && !p.title.includes(kw) && !p.author.includes(kw) && !p.content.includes(kw)) return;

        if(!p.learnDate) {
            // é¢˜åº“å¡ç‰‡
            const el = document.createElement('div');
            el.className = 'poem-card';
            el.innerHTML = `<b>${p.title}</b><small>${p.author}</small>`;
            el.onclick = () => showStudy(p.id, 'new');
            grid.appendChild(el);
        } else {
            done++;
            const lTime = new Date(p.learnDate).setHours(0,0,0,0);
            let need = false, idx = -1, over = false;
            
            for(let i=0; i<intervals.length; i++) {
                const tDate = lTime + intervals[i]*86400000;
                if(p.reviews && p.reviews.includes(i)) continue;
                if(tDate <= today) { need=true; idx=i; if(tDate<today) over=true; break; }
            }

            if(need) {
                todo++;
                const el = document.createElement('div');
                el.className = `task-card ${over?'overdue':'review'}`;
                el.innerHTML = `
                    <span class="badge ${over?'bg-ovd':'bg-rev'}">${over?'é€¾æœŸè¡¥å¡':'ä»Šæ—¥å¤ä¹ '}</span>
                    <h4>${p.title}</h4>
                    <div style="font-size:12px; color:#666;">${p.author}</div>
                `;
                el.onclick = () => showStudy(p.id, 'rev', idx);
                list.appendChild(el);
            } else {
                // å·²å­¦ä¼šçš„å¡ç‰‡
                const el = document.createElement('div');
                el.className = 'poem-card learned';
                el.innerHTML = `<b>${p.title}</b><small>${p.author}</small>`;
                el.onclick = () => { if(confirm("é‡èƒŒè¿™é¦–è¯—ï¼Ÿ")) showStudy(p.id, 'rev', 999); };
                grid.appendChild(el);
            }
        }
    });

    if(list.children.length===0) list.innerHTML = `<div style="text-align:center;color:#9ca3af;padding:30px;font-size:13px;background:rgba(255,255,255,0.5);border-radius:10px;">ğŸƒ ä»Šæ—¥æ— å¾…åŠ<br>å»å³è¾¹é€‰é¦–æ–°è¯—å§</div>`;
    
    document.getElementById('count-todo').innerText = todo;
    document.getElementById('count-done').innerText = done;
}

async function loadUserData(userId) {
    if (window.useLocalMode || !supabase) {
        console.log('æœ¬åœ°æ¨¡å¼ï¼Œè·³è¿‡äº‘ç«¯æ•°æ®åŠ è½½');
        return;
    }
    
    try {
        const { data, error } = await supabase
            .from('users')
            .select('poem_data')
            .eq('id', userId)
            .single();
            
        if (!error && data && data.poem_data) {
            poems = data.poem_data;
            localStorage.setItem('poem_data', JSON.stringify(poems));
            renderUI();
        }
    } catch(e) {
        console.error("åŠ è½½ç”¨æˆ·æ•°æ®å¤±è´¥:", e);
    }
}

async function saveUserData(userId) {
    if (window.useLocalMode || !supabase) {
        localStorage.setItem('poem_data', JSON.stringify(poems));
        return;
    }
    
    try {
        await supabase
            .from('users')
            .update({ poem_data: poems })
            .eq('id', userId);
        localStorage.setItem('poem_data', JSON.stringify(poems));
    } catch(e) {
        console.error('ä¿å­˜ç”¨æˆ·æ•°æ®å¤±è´¥:', e);
        localStorage.setItem('poem_data', JSON.stringify(poems));
    }
}

// ==========================================
// è®¤è¯å‡½æ•°ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ==========================================
async function doRegister() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const authMsg = document.getElementById('auth-msg');
    
    authMsg.innerText = '';
    authMsg.style.color = 'red';
    
    if (!email || !password) {
        authMsg.innerText = "è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯";
        return;
    }
    
    if (password.length < 6) {
        authMsg.innerText = "å¯†ç è‡³å°‘éœ€è¦6ä½";
        return;
    }
    
    // æœ¬åœ°æ³¨å†Œæ¨¡å¼ï¼ˆç®€åŒ–ï¼‰
    authMsg.innerText = "æ­£åœ¨æ³¨å†Œï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰...";
    
    setTimeout(() => {
        localStorage.setItem('local_user_email', email);
        localStorage.setItem('local_user_password', password);
        
        authMsg.style.color = 'green';
        authMsg.innerText = "æ³¨å†ŒæˆåŠŸï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰ï¼";
        
        setTimeout(() => {
            doLogin();
        }, 1000);
    }, 500);
}

async function doLogin() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    const authMsg = document.getElementById('auth-msg');
    
    authMsg.innerText = '';
    authMsg.style.color = 'red';
    
    if (!email || !password) {
        authMsg.innerText = "è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯";
        return;
    }
    
    // æœ¬åœ°ç™»å½•æ¨¡å¼ï¼ˆç®€åŒ–ï¼‰
    authMsg.innerText = "æ­£åœ¨ç™»å½•ï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰...";
    
    setTimeout(() => {
        const savedEmail = localStorage.getItem('local_user_email');
        const savedPassword = localStorage.getItem('local_user_password');
        
        if (email === savedEmail && password === savedPassword) {
            authMsg.style.color = 'green';
            authMsg.innerText = "ç™»å½•æˆåŠŸï¼ˆæœ¬åœ°æ¨¡å¼ï¼‰ï¼";
            
            setTimeout(() => {
                closeModal('auth-modal');
                updateAuthUI({ user: { email } });
                alert(`æ¬¢è¿ï¼Œ${email.split('@')[0]}ï¼`);
            }, 1000);
        } else {
            authMsg.innerText = "é‚®ç®±æˆ–å¯†ç é”™è¯¯";
        }
    }, 500);
}

async function doLogout() {
    if (confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
        localStorage.removeItem('local_user_email');
        localStorage.removeItem('local_user_password');
        updateAuthUI();
        alert('å·²é€€å‡ºç™»å½•');
    }
}

function updateAuthUI() {
    const nameEl = document.getElementById('user-name');
    const dot = document.getElementById('status-dot');
    const authWidget = document.querySelector('.auth-widget');
    
    const localEmail = localStorage.getItem('local_user_email');
    
    if (localEmail) {
        const displayName = localEmail.split('@')[0];
        nameEl.innerText = displayName + ' (æœ¬åœ°)';
        dot.className = 'status-dot online';
        
        authWidget.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="status-dot online"></span>
                <span style="font-weight:600; color:#374151;">${displayName} (æœ¬åœ°)</span>
            </div>
            <button class="btn-text" onclick="doLogout()" style="font-size:12px;">é€€å‡º</button>
        `;
    } else {
        nameEl.innerText = 'æœ¬åœ°è®¿å®¢';
        dot.className = 'status-dot';
        
        authWidget.innerHTML = `
            <div style="display:flex; align-items:center; gap:8px;">
                <span class="status-dot"></span>
                <span style="font-weight:600; color:#374151;">æœ¬åœ°è®¿å®¢</span>
            </div>
            <button class="btn-text" onclick="showAuth()" style="font-size:12px;">ç™»å½•/æ³¨å†Œ</button>
        `;
    }
}

// ==========================================
// è¯—è¯å­¦ä¹ åŠŸèƒ½
// ==========================================
function showStudy(id, type, idx) {
    const p = poems.find(x=>x.id===id);
    curId=id; curType=type; curRevIdx=idx;
    document.getElementById('s-title').innerText = p.title;
    document.getElementById('s-author').innerText = `[${p.author}]`;
    document.getElementById('s-text').innerText = p.content;
    
    const tag = document.getElementById('study-tag');
    if(type==='new') { tag.innerText='æ–°å­¦'; tag.className='badge bg-new'; }
    else { tag.innerText='å¤ä¹ '; tag.className='badge bg-rev'; }
    
    document.getElementById('study-modal').style.display='flex';
}

async function finishTask() {
    const p = poems.find(x=>x.id===curId);
    if(curType==='new') { 
        p.learnDate = new Date().toISOString(); 
        p.reviews=[]; 
    } else { 
        if(!p.reviews) p.reviews=[];
        if(curRevIdx!==999) p.reviews.push(curRevIdx);
    }
    
    fireConfetti();
    localStorage.setItem('poem_data', JSON.stringify(poems));
    closeModal('study-modal');
    renderUI();
}

// ==========================================
// å¯¼å…¥åŠŸèƒ½ï¼ˆç®€åŒ–ç‰ˆï¼‰
// ==========================================
function handleFileImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        document.getElementById('import-txt').value = e.target.result;
    };
    reader.readAsText(file);
}

function doImport() {
    const input = document.getElementById('import-txt').value.trim();
    if (!input) {
        document.getElementById('import-errors').textContent = 'è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©æ–‡ä»¶';
        return;
    }
    
    // ç®€å•çš„å¯¼å…¥é€»è¾‘ï¼ˆä½ å¯ä»¥æ ¹æ®éœ€è¦æ‰©å±•ï¼‰
    const lines = input.split('\n').filter(line => line.trim());
    let importedCount = 0;
    
    lines.forEach(line => {
        if (line.includes('|')) {
            const parts = line.split('|').map(p => p.trim());
            if (parts.length >= 3) {
                poems.push({
                    id: Date.now() + Math.random(),
                    title: parts[0],
                    author: parts[1],
                    content: parts.slice(2).join('|')
                });
                importedCount++;
            }
        }
    });
    
    if (importedCount > 0) {
        localStorage.setItem('poem_data', JSON.stringify(poems));
        renderUI();
        closeModal('import-modal');
        alert(`å¯¼å…¥å®Œæˆ! æˆåŠŸå¯¼å…¥: ${importedCount} é¦–`);
    }
}

// ==========================================
// è¾…åŠ©å‡½æ•°
// ==========================================
function showAuth() { 
    document.getElementById('auth-modal').style.display='flex'; 
    document.getElementById('auth-msg').innerText = '';
    document.getElementById('email').value = '';
    document.getElementById('password').value = '';
}

function showImport() { 
    document.getElementById('import-modal').style.display='flex'; 
    document.getElementById('import-errors').innerHTML = '';
    document.getElementById('import-txt').value = '';
    document.getElementById('import-file').value = '';
}

function closeModal(id) { 
    document.getElementById(id).style.display='none'; 
}

function resetAll() { 
    if(confirm("ç¡®å®šæ¸…ç©ºé‡ç½®æ‰€æœ‰æ•°æ®å—ï¼Ÿ")) { 
        localStorage.removeItem('poem_data'); 
        localStorage.removeItem('local_user_email');
        localStorage.removeItem('local_user_password');
        location.reload(); 
    }
}

function fireConfetti() {
    const c=document.getElementById('confetti-canvas'),x=c.getContext('2d');
    c.width=innerWidth;c.height=innerHeight;
    let p=[];for(let i=0;i<120;i++)p.push({x:c.width/2,y:c.height/2,v:{x:(Math.random()-.5)*25,y:(Math.random()-.5)*25},c:`hsl(${Math.random()*120+100},80%,60%)`});
    (function f(){x.clearRect(0,0,c.width,c.height);p.forEach(k=>{k.x+=k.v.x;k.y+=k.v.y;k.v.y+=.5;x.fillStyle=k.c;x.fillRect(k.x,k.y,6,6)});if(p[0].y<c.height)requestAnimationFrame(f)})();
}

// ==========================================
// åˆå§‹åŒ–
// ==========================================
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸ“„ DOM åŠ è½½å®Œæˆ');
    
    // ä¿®å¤æœç´¢æ¡†äº‹ä»¶ç›‘å¬
    const searchInput = document.getElementById('search');
    if (searchInput) {
        searchInput.oninput = renderUI;
    }
    
    // åˆå§‹åŒ–åº”ç”¨
    init();
});
</script>
