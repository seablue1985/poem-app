<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- ğŸ“± PWA æ ¸å¿ƒé…ç½® -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#e0f2f1"> <!-- è¿™é‡Œçš„é¢œè‰²è¦å’Œæ‚¨çš„èƒŒæ™¯è‰²ä¸€è‡´ -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3655/3655562.png"> <!-- è¿™é‡Œå¯ä»¥æ¢æˆæ‚¨å–œæ¬¢çš„å›¾æ ‡é“¾æ¥ -->
<link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/3655/3655562.png">

<style>
    /* ğŸ“± é’ˆå¯¹æ‰‹æœº App æ¨¡å¼çš„é¢å¤–ä¼˜åŒ– */
    @media (max-width: 768px) {
        body { padding-bottom: 40px; } /* é˜²æ­¢åº•éƒ¨è¢«æ‰‹æœºæ¨ªæ¡æŒ¡ä½ */
        .app-container { padding: 10px; gap: 15px; height: auto; }
        .sidebar, .main-content { border-radius: 15px; padding: 15px; }
        /* è®©æ‰‹æœºä¸Šå­—ä½“ç¨å¾®å¤§ä¸€ç‚¹ */
        .task-card h4 { font-size: 18px; }
        .poem-card b { font-size: 18px; }
    }
</style>
   <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤è¯—Â·äº‘ç«¯é›…é›†</title>
    <style>
        :root {
            /* ğŸŸ¢ æ ¸å¿ƒé…è‰²ï¼šæ¸…æ–°æŠ¤çœ¼ç»¿ */
            --bg-gradient: linear-gradient(135deg, #e0f2f1 0%, #a7f3d0 100%); /* æ™¨é›¾ç»¿æ¸å˜ */
            --glass-bg: rgba(255, 255, 255, 0.75);
            --glass-border: rgba(255, 255, 255, 0.8);
            --primary: #059669;    /* ç¿¡ç¿ ç»¿ - ä¸»æŒ‰é’®/é‡ç‚¹ */
            --primary-dark: #047857;
            --secondary: #34d399;  /* å«©èŠ½ç»¿ - è£…é¥° */
            --text-main: #1f2937;  /* æ·±ç° - æ­£æ–‡ */
            --text-sub: #4b5563;   /* æµ…ç° - è¾…åŠ©æ–‡å­— */
            --accent-red: #ef4444; /* é€¾æœŸ/é”™è¯¯ */
            --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        body {
            background: var(--bg-gradient);
            font-family: -apple-system, "PingFang SC", "Microsoft YaHei", sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            color: var(--text-main);
            overflow-x: hidden;
        }

        /* === å¸ƒå±€å®¹å™¨ === */
        .app-container {
            max-width: 1600px; /* å®½å±é€‚é… */
            margin: 0 auto;
            padding: 20px;
            display: grid;
            grid-template-columns: 320px 1fr; /* å·¦ä¾§å›ºå®š320pxï¼Œå³ä¾§è‡ªé€‚åº” */
            gap: 25px;
            height: 95vh;
        }

        /* === å…¬å…±å¡ç‰‡æ ·å¼ (æ¯›ç»ç’ƒ) === */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            box-shadow: var(--shadow);
            padding: 20px;
        }

        /* === å·¦ä¾§è¾¹æ  (ä¿¡æ¯æµ) === */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .brand-area h1 {
            font-size: 24px;
            color: var(--primary-dark);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* ç™»å½•æ¡ */
        .auth-widget {
            background: white;
            border-radius: 12px;
            padding: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #ccc; display: inline-block; }
        .status-dot.online { background: var(--primary); box-shadow: 0 0 8px var(--primary); }

        /* ç»Ÿè®¡å— */
        .stats-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .stat-box {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-num { font-size: 24px; font-weight: 800; color: var(--primary); display: block; }
        .stat-desc { font-size: 12px; color: var(--text-sub); }

        /* ä»»åŠ¡åˆ—è¡¨ */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .task-card {
            background: white;
            padding: 15px;
            border-radius: 12px;
            border-left: 5px solid transparent;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            position: relative;
            overflow: hidden;
        }
        .task-card:hover { transform: translateX(5px); }
        .task-card.new { border-left-color: var(--primary); }
        .task-card.review { border-left-color: #10b981; }
        .task-card.overdue { border-left-color: var(--accent-red); }
        .task-card h4 { margin: 0 0 5px 0; font-size: 16px; }
        
        /* æ ‡ç­¾ */
        .badge {
            font-size: 10px; padding: 2px 6px; border-radius: 4px; color: white; display: inline-block; margin-bottom: 4px;
        }
        .bg-new { background: var(--primary); }
        .bg-rev { background: #10b981; }
        .bg-ovd { background: var(--accent-red); }

        /* === å³ä¾§ä¸»åŒºåŸŸ (ä¹¦åº“) === */
        .main-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
            overflow: hidden; /* é˜²æ­¢æ’‘å¼€é¡µé¢ */
        }

        .toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .search-bar {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            font-size: 16px;
            border: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.03);
            outline: none;
            transition: box-shadow 0.3s;
        }
        .search-bar:focus { box-shadow: 0 4px 20px rgba(5, 150, 105, 0.15); }

        .btn-icon {
            width: 46px; height: 46px;
            border-radius: 12px;
            border: none;
            background: white;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }
        .btn-icon:hover { background: var(--primary); color: white; transform: translateY(-2px); }

        /* è¯—è¯ç½‘æ ¼ (è‡ªé€‚åº”å®½å±) */
        .library-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 5px; /* é˜²æ­¢é˜´å½±è¢«åˆ‡ */
        }
        .poem-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); /* å®½å±è‡ªé€‚åº”åˆ—æ•° */
            gap: 15px;
        }
        
        .poem-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            position: relative;
        }
        .poem-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(5, 150, 105, 0.1);
            border-color: var(--secondary);
        }
        .poem-card b { display: block; font-size: 18px; margin-bottom: 5px; color: var(--text-main); }
        .poem-card small { color: #888; font-size: 13px; }
        .poem-card.learned { opacity: 0.6; background: #f9fafb; }
        .poem-card.learned::after {
            content: "âœ…"; position: absolute; top: 10px; right: 10px; font-size: 12px;
        }

        /* === æŒ‰é’®é€šç”¨ === */
        .btn { padding: 10px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); }
        .btn-text { background: none; color: var(--primary); }
        
        /* === å¼¹çª—æ ·å¼ === */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.4); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-card {
            background: white;
            width: 500px;
            max-width: 90%;
            border-radius: 24px;
            padding: 30px;
            text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        .poem-content-display {
            font-family: "KaiTi", "STKaiti", "æ¥·ä½“", serif;
            font-size: 26px;
            line-height: 1.8;
            background: #f0fdf4;
            padding: 25px;
            border-radius: 16px;
            margin: 20px 0;
            color: #064e3b;
            white-space: pre-wrap;
            border: 1px dashed #6ee7b7;
        }

        /* è¾“å…¥æ¡†ç¾åŒ– */
        .input-group { margin-bottom: 15px; }
        .input-field { width: 100%; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; margin-top: 5px; box-sizing: border-box; }

        /* å“åº”å¼ï¼šæ‰‹æœºç«¯å˜ä¸ºå•åˆ— */
        @media (max-width: 768px) {
            .app-container { grid-template-columns: 1fr; height: auto; padding: 15px; }
            .sidebar { height: auto; overflow: visible; }
            .main-content { height: auto; }
            .library-scroll { overflow: visible; }
            .poem-grid { grid-template-columns: repeat(2, 1fr); }
        }
        
        #confetti-canvas { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 2000; }
    </style>
</head>
<body>
    <canvas id="confetti-canvas"></canvas>

    <div class="app-container">
        <!-- å·¦ä¾§è¾¹æ ï¼šçŠ¶æ€ä¸ä»»åŠ¡ -->
        <aside class="sidebar glass-card">
            <div class="brand-area">
                <h1>ğŸƒ å¤è¯—Â·äº‘ç«¯é›…é›†</h1>
                <p style="font-size:12px; color:#666; margin-top:5px;">è‰¾å®¾æµ©æ–¯è®°å¿†æ›²çº¿ Â· æ™ºèƒ½è§„åˆ’</p>
            </div>

            <!-- ç™»å½•çŠ¶æ€ -->
            <div class="auth-widget">
                <div style="display:flex; align-items:center; gap:8px;">
                    <span id="status-dot" class="status-dot"></span>
                    <span id="user-name" style="font-weight:600; color:#374151;">æœ¬åœ°è®¿å®¢</span>
                </div>
                <button class="btn-text" onclick="showAuth()" style="font-size:12px;">åˆ‡æ¢è´¦å·</button>
            </div>

            <!-- æ•°æ®ç»Ÿè®¡ -->
            <div class="stats-row">
                <div class="stat-box">
                    <span class="stat-num" id="count-todo">0</span>
                    <span class="stat-desc">ä»Šæ—¥å¾…åŠ</span>
                </div>
                <div class="stat-box">
                    <span class="stat-num" id="count-done">0</span>
                    <span class="stat-desc">å·²ç†ŸèƒŒ</span>
                </div>
            </div>

            <!-- ä»Šæ—¥ä»»åŠ¡ -->
            <div>
                <h3 style="margin-bottom:15px; color:#374151; display:flex; justify-content:space-between; align-items:center;">
                    ğŸ“… ä»Šæ—¥ä»»åŠ¡
                    <span style="font-size:12px; font-weight:normal; color:#888;">ç‚¹æ­¤å¼€å§‹èƒŒè¯µ</span>
                </h3>
                <div id="task-list" class="task-list">
                    <!-- ä»»åŠ¡å¡ç‰‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </aside>

        <!-- å³ä¾§ä¸»åŒºåŸŸï¼šè—ä¹¦é˜ -->
        <main class="main-content glass-card">
            <div class="toolbar">
                <input type="text" id="search" class="search-bar" placeholder="ğŸ” æœç´¢è¯—è¯åº“ (å¦‚ï¼šæç™½ã€æ˜¥æ™“)..." oninput="renderUI()">
                <button class="btn-icon" onclick="showImport()" title="å¯¼å…¥æ–°è¯—">â•</button>
                <button class="btn-icon" onclick="resetAll()" title="æ¸…ç©ºé‡ç½®" style="color:var(--accent-red)">â†»</button>
            </div>

            <h3 style="margin:10px 0; color:#374151;">ğŸ“š è—ä¹¦é˜ (ç‚¹å‡»å¡ç‰‡å­¦ä¹ )</h3>
            
            <div class="library-scroll">
                <div id="lib-grid" class="poem-grid">
                    <!-- è¯—è¯å¡ç‰‡ç”±JSç”Ÿæˆ -->
                </div>
            </div>
        </main>
    </div>

    <!-- å¼¹çª—ï¼šç™»å½• -->
    <div id="auth-modal" class="modal-overlay">
        <div class="modal-card">
            <h2>â˜ï¸ äº‘ç«¯åŒæ­¥</h2>
            <p style="color:#666; font-size:14px;">ç™»å½•åï¼Œæ‚¨çš„èƒŒè¯µè¿›åº¦å°†åœ¨æ‰€æœ‰è®¾å¤‡é—´è‡ªåŠ¨åŒæ­¥ã€‚</p>
            <div class="input-group">
                <input type="text" id="email" class="input-field" placeholder="è¯·è¾“å…¥é‚®ç®±æˆ–ç”¨æˆ·å">
                <input type="password" id="password" class="input-field" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn btn-primary" style="width:100%; padding:12px;" onclick="doLogin()">ç™»å½•å¹¶åŒæ­¥</button>
            <button class="btn btn-text" style="width:100%; margin-top:10px;" onclick="doRegister()">æ³¨å†Œæ–°è´¦å·</button>
            <div id="auth-msg" style="color:red; margin-top:10px; font-size:12px;"></div>
            <button class="btn-text" onclick="closeModal('auth-modal')" style="position:absolute; top:15px; right:15px; font-size:20px;">Ã—</button>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šèƒŒè¯µç•Œé¢ -->
    <div id="study-modal" class="modal-overlay">
        <div class="modal-card" style="width:600px;">
            <span id="study-tag" class="badge bg-new" style="font-size:12px; padding:4px 10px;">æ–°å­¦</span>
            <h2 id="s-title" style="margin:10px 0; font-size:28px; color:#064e3b;"></h2>
            <div id="s-author" style="color:#6b7280; font-weight:500;"></div>
            
            <div id="s-text" class="poem-content-display"></div>
            
            <div style="display:flex; gap:15px; margin-top:20px;">
                <button class="btn" style="background:#f3f4f6; color:#666; flex:1;" onclick="closeModal('study-modal')">ç¨åå¤ä¹ </button>
                <button class="btn btn-primary" style="flex:2; font-size:16px;" onclick="finishTask()">âœ… æˆ‘èƒŒä¸‹æ¥äº†</button>
            </div>
        </div>
    </div>

    <!-- å¼¹çª—ï¼šå¯¼å…¥ -->
    <div id="import-modal" class="modal-overlay">
        <div class="modal-card">
            <h3>æ‰¹é‡å¯¼å…¥è¯—è¯</h3>
            
            <!-- æ ¼å¼é€‰æ‹©å™¨ -->
            <div class="input-group">
                <label style="font-size:14px;">å¯¼å…¥æ ¼å¼:</label>
                <select id="import-format" class="input-field">
                    <option value="pipe">æ ‡é¢˜|ä½œè€…|å†…å®¹ (ä¸€è¡Œä¸€é¦–)</option>
                    <option value="json">JSONæ ¼å¼</option>
                    <option value="plain">æ™®é€šæ–‡æœ¬ (æ ‡é¢˜\nä½œè€…\nå†…å®¹\nç©ºè¡Œåˆ†éš”)</option>
                </select>
            </div>
            
            <!-- æ–‡æœ¬è¾“å…¥åŒºåŸŸ -->
            <div class="input-group">
                <label style="font-size:14px;">è¾“å…¥å†…å®¹:</label>
                <textarea id="import-txt" class="input-field" style="height:120px;" placeholder="æ ¹æ®æ‰€é€‰æ ¼å¼è¾“å…¥å†…å®¹"></textarea>
            </div>
            
            <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
            <div class="input-group">
                <label style="font-size:14px;">æˆ–ä»æ–‡ä»¶å¯¼å…¥:</label>
                <input type="file" id="import-file" class="input-field" accept=".txt,.json" 
                       style="padding:8px;" onchange="handleFileImport(event)">
            </div>
            
            <!-- å¯¼å…¥é€‰é¡¹ -->
            <div class="input-group">
                <label>
                    <input type="checkbox" id="skip-duplicates" checked> è·³è¿‡é‡å¤è¯—è¯
                </label>
                <label style="margin-left:15px;">
                    <input type="checkbox" id="overwrite-existing"> è¦†ç›–é‡å¤è¯—è¯
                </label>
            </div>
            
            <!-- é”™è¯¯æç¤ºåŒºåŸŸ -->
            <div id="import-errors" style="color:var(--accent-red); margin:10px 0; font-size:13px; max-height:100px; overflow-y:auto;"></div>
            
            <button class="btn btn-primary" style="width:100%; margin-top:15px;" onclick="doImport()">ç¡®è®¤å¯¼å…¥</button>
            <button class="btn-text" onclick="closeModal('import-modal')" style="position:absolute; top:15px; right:15px; font-size:20px;">Ã—</button>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸŸ¢ã€é‡è¦ã€‘è¯·åœ¨æ­¤å¡«å…¥æ‚¨çš„ Cloudflare Worker åœ°å€
        // ==========================================
        const API_URL = "https://poemreciter.337968914.workers.dev"; 
        // ==========================================

        const defaultData = [
            {id:1,title:"æ±Ÿå—",author:"æ±‰ä¹åºœ",content:"æ±Ÿå—å¯é‡‡è²ï¼Œè²å¶ä½•ç”°ç”°ã€‚\né±¼æˆè²å¶é—´ã€‚\né±¼æˆè²å¶ä¸œï¼Œé±¼æˆè²å¶è¥¿ï¼Œ\né±¼æˆè²å¶å—ï¼Œé±¼æˆè²å¶åŒ—ã€‚"},
            {id:2,title:"å’é¹…",author:"éª†å®¾ç‹",content:"é¹…ï¼Œé¹…ï¼Œé¹…ï¼Œæ›²é¡¹å‘å¤©æ­Œã€‚\nç™½æ¯›æµ®ç»¿æ°´ï¼Œçº¢æŒæ‹¨æ¸…æ³¢ã€‚"},
            {id:3,title:"æ˜¥æ™“",author:"å­Ÿæµ©ç„¶",content:"æ˜¥çœ ä¸è§‰æ™“ï¼Œå¤„å¤„é—»å•¼é¸Ÿã€‚\nå¤œæ¥é£é›¨å£°ï¼ŒèŠ±è½çŸ¥å¤šå°‘ã€‚"},
            {id:4,title:"é™å¤œæ€",author:"æç™½",content:"åºŠå‰æ˜æœˆå…‰ï¼Œç–‘æ˜¯åœ°ä¸Šéœœã€‚\nä¸¾å¤´æœ›æ˜æœˆï¼Œä½å¤´æ€æ•…ä¹¡ã€‚"},
            {id:5,title:"é£",author:"æå³¤",content:"è§£è½ä¸‰ç§‹å¶ï¼Œèƒ½å¼€äºŒæœˆèŠ±ã€‚\nè¿‡æ±Ÿåƒå°ºæµªï¼Œå…¥ç«¹ä¸‡ç«¿æ–œã€‚"},
            {id:6,title:"å’æŸ³",author:"è´ºçŸ¥ç« ",content:"ç¢§ç‰å¦†æˆä¸€æ ‘é«˜ï¼Œä¸‡æ¡å‚ä¸‹ç»¿ä¸ç»¦ã€‚\nä¸çŸ¥ç»†å¶è°è£å‡ºï¼ŒäºŒæœˆæ˜¥é£ä¼¼å‰ªåˆ€ã€‚"}
        ];

        let poems = [];
        let userInfo = JSON.parse(localStorage.getItem('cf_user') || 'null');
        let curId=null, curType=null, curRevIdx=null;

        async function init() {
            try {
                const localData = localStorage.getItem('poem_data');
                poems = localData ? JSON.parse(localData) : JSON.parse(JSON.stringify(defaultData));
                updateAuthUI();
                if(userInfo) {
                    try {
                        await syncData(true);
                    } catch(e) {
                        console.log("åŒæ­¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:", e.message);
                    }
                }
                renderUI();
            } catch(e) {
                console.error("åˆå§‹åŒ–å¤±è´¥:", e);
                // æ— è®ºå¦‚ä½•æ¸²æŸ“é¡µé¢
                renderUI();
            }
        }

        // --- API é€»è¾‘ ---
        async function apiCall(endpoint, payload) {
            try {
                if(API_URL.includes("YOUR-NAME")) { 
                    console.warn("APIåœ°å€æœªé…ç½®"); 
                    return {success:false, error:"æœªé…ç½®APIåœ°å€"}; 
                }
                
                // éªŒè¯API_URLæ ¼å¼
                const fullUrl = API_URL + endpoint;
                if(fullUrl.includes("//")) {
                    console.error("URLæ ¼å¼é”™è¯¯ï¼ŒåŒ…å«åŒæ–œæ :", fullUrl);
                    return {success:false, error:"APIé…ç½®é”™è¯¯"};
                }
                
                const res = await fetch(fullUrl, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                return await res.json();
            } catch(e) { 
                console.error("APIè°ƒç”¨å¤±è´¥:", e);
                return { success: false, error: "ç½‘ç»œè¿æ¥å¤±è´¥" }; 
            }
        }

        async function doRegister() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            if(!email || !password) return alert("è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯");
            const res = await apiCall('/register', { email, password, initialData: poems });
            if(res.success) alert("æ³¨å†ŒæˆåŠŸï¼Œè¯·ç‚¹å‡»ç™»å½•");
            else document.getElementById('auth-msg').innerText = res.error;
        }

        async function doLogin() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const res = await apiCall('/login', { email, password });
            if(res.success) {
                userInfo = { email, password };
                localStorage.setItem('cf_user', JSON.stringify(userInfo));
                if(res.data && res.data.length > 0) { poems = res.data; saveLocal(); }
                updateAuthUI();
                closeModal('auth-modal');
                renderUI();
                alert("æ¬¢è¿å›æ¥ï¼æ•°æ®å·²åŒæ­¥ã€‚");
            } else {
                document.getElementById('auth-msg').innerText = res.error;
            }
        }

        async function syncData(silent = false) {
            if(!userInfo) return;
            const res = await apiCall('/sync', { ...userInfo, data: poems });
            if(!res.success && !silent) alert("åŒæ­¥å¤±è´¥: " + res.error);
        }

        function doLogout() {
            if(confirm("ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ")) {
                userInfo = null;
                localStorage.removeItem('cf_user');
                updateAuthUI();
            }
        }
        function saveLocal() { localStorage.setItem('poem_data', JSON.stringify(poems)); }

        // --- æ¸²æŸ“é€»è¾‘ ---
        function renderUI() {
            const list = document.getElementById('task-list');
            const grid = document.getElementById('lib-grid');
            const kw = document.getElementById('search').value.toLowerCase();
            list.innerHTML = ''; grid.innerHTML = '';
            
            let todo=0, done=0;
            const today = new Date().setHours(0,0,0,0);
            const intervals = [1,2,4,7,15,30];

            // æ’åºï¼šæœªå­¦çš„æŒ‰IDæ’ï¼Œå·²å­¦çš„é å
            const sortedPoems = [...poems].sort((a,b) => (a.id - b.id));

            sortedPoems.forEach(p => {
                if(kw && !p.title.includes(kw) && !p.author.includes(kw) && !p.content.includes(kw)) return;

                if(!p.learnDate) {
                    // é¢˜åº“å¡ç‰‡
                    const el = document.createElement('div');
                    el.className = 'poem-card';
                    el.innerHTML = `<b>${p.title}</b><small>${p.author}</small>`;
                    el.onclick = () => showStudy(p.id, 'new');
                    grid.appendChild(el);
                } else {
                    done++;
                    const lTime = new Date(p.learnDate).setHours(0,0,0,0);
                    let need = false, idx = -1, over = false;
                    
                    for(let i=0; i<intervals.length; i++) {
                        const tDate = lTime + intervals[i]*86400000;
                        if(p.reviews && p.reviews.includes(i)) continue;
                        if(tDate <= today) { need=true; idx=i; if(tDate<today) over=true; break; }
                    }

                    if(need) {
                        todo++;
                        const el = document.createElement('div');
                        el.className = `task-card ${over?'overdue':'review'}`;
                        el.innerHTML = `
                            <span class="badge ${over?'bg-ovd':'bg-rev'}">${over?'é€¾æœŸè¡¥å¡':'ä»Šæ—¥å¤ä¹ '}</span>
                            <h4>${p.title}</h4>
                            <div style="font-size:12px; color:#666;">${p.author}</div>
                        `;
                        el.onclick = () => showStudy(p.id, 'rev', idx);
                        list.appendChild(el);
                    } else {
                        // å·²å­¦ä¼šçš„å¡ç‰‡
                        const el = document.createElement('div');
                        el.className = 'poem-card learned';
                        el.innerHTML = `<b>${p.title}</b><small>${p.author}</small>`;
                        el.onclick = () => { if(confirm("é‡èƒŒè¿™é¦–è¯—ï¼Ÿ")) showStudy(p.id, 'rev', 999); };
                        grid.appendChild(el);
                    }
                }
            });

            if(list.children.length===0) list.innerHTML = `<div style="text-align:center;color:#9ca3af;padding:30px;font-size:13px;background:rgba(255,255,255,0.5);border-radius:10px;">ğŸƒ ä»Šæ—¥æ— å¾…åŠ<br>å»å³è¾¹é€‰é¦–æ–°è¯—å§</div>`;
            
            document.getElementById('count-todo').innerText = todo;
            document.getElementById('count-done').innerText = done;
        }

        function showStudy(id, type, idx) {
            const p = poems.find(x=>x.id===id);
            curId=id; curType=type; curRevIdx=idx;
            document.getElementById('s-title').innerText = p.title;
            document.getElementById('s-author').innerText = `[${p.author}]`;
            document.getElementById('s-text').innerText = p.content;
            
            const tag = document.getElementById('study-tag');
            if(type==='new') { tag.innerText='æ–°å­¦'; tag.className='badge bg-new'; }
            else { tag.innerText='å¤ä¹ '; tag.className='badge bg-rev'; }
            
            document.getElementById('study-modal').style.display='flex';
        }

        async function finishTask() {
            const p = poems.find(x=>x.id===curId);
            if(curType==='new') { p.learnDate = new Date().toISOString(); p.reviews=[]; }
            else { if(!p.reviews) p.reviews=[]; if(curRevIdx!==999) p.reviews.push(curRevIdx); }
            
            fireConfetti();
            saveLocal();
            closeModal('study-modal');
            renderUI();
            if(userInfo) await syncData(true);
        }

        function updateAuthUI() {
            const nameEl = document.getElementById('user-name');
            const dot = document.getElementById('status-dot');
            if(userInfo) {
                nameEl.innerText = userInfo.email.split('@')[0];
                dot.className = 'status-dot online';
            } else {
                nameEl.innerText = 'æœ¬åœ°è®¿å®¢';
                dot.className = 'status-dot';
            }
        }

        // --- å¯¼å…¥åŠŸèƒ½å¢å¼º ---
        function handleFileImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            const formatSelect = document.getElementById('import-format');
            
            // æ ¹æ®æ–‡ä»¶æ‰©å±•åè‡ªåŠ¨é€‰æ‹©æ ¼å¼
            if (file.name.endsWith('.json')) {
                formatSelect.value = 'json';
            } else if (file.name.endsWith('.txt')) {
                // ä¿æŒå½“å‰é€‰æ‹©æˆ–é»˜è®¤
            }
            
            reader.onload = function(e) {
                document.getElementById('import-txt').value = e.target.result;
            };
            
            reader.readAsText(file);
        }

        function doImport() {
            const input = document.getElementById('import-txt').value.trim();
            const format = document.getElementById('import-format').value;
            const skipDuplicates = document.getElementById('skip-duplicates').checked;
            const overwriteExisting = document.getElementById('overwrite-existing').checked;
            const errorContainer = document.getElementById('import-errors');
            
            // æ¸…ç©ºä¹‹å‰çš„é”™è¯¯
            errorContainer.innerHTML = '';
            
            if (!input) {
                errorContainer.textContent = 'è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©æ–‡ä»¶';
                return;
            }
            
            let poemsToImport = [];
            let errors = [];
            
            // æ ¹æ®ä¸åŒæ ¼å¼è§£æ
            try {
                switch (format) {
                    case 'pipe':
                        [poemsToImport, errors] = parsePipeFormat(input);
                        break;
                    case 'json':
                        [poemsToImport, errors] = parseJsonFormat(input);
                        break;
                    case 'plain':
                        [poemsToImport, errors] = parsePlainTextFormat(input);
                        break;
                }
            } catch (e) {
                errors.push(`è§£æé”™è¯¯: ${e.message}`);
            }
            
            // æ˜¾ç¤ºè§£æé”™è¯¯
            if (errors.length > 0) {
                errorContainer.innerHTML = errors.map(err => `<div>â€¢ ${err}</div>`).join('');
                return;
            }
            
            // é‡å¤æ£€æµ‹å’Œå¤„ç†
            let importedCount = 0;
            let skippedCount = 0;
            let overwrittenCount = 0;
            
            poemsToImport.forEach(poem => {
                // æ£€æŸ¥æ˜¯å¦é‡å¤ (åŸºäºæ ‡é¢˜å’Œä½œè€…)
                const existingIndex = poems.findIndex(p => 
                    p.title.trim() === poem.title.trim() && 
                    p.author.trim() === poem.author.trim()
                );
                
                if (existingIndex >= 0) {
                    // å¤„ç†é‡å¤é¡¹
                    if (overwriteExisting) {
                        // ä¿ç•™åŸæœ‰çš„å­¦ä¹ çŠ¶æ€
                        poem.id = poems[existingIndex].id;
                        poem.learnDate = poems[existingIndex].learnDate;
                        poem.reviews = poems[existingIndex].reviews;
                        
                        poems[existingIndex] = poem;
                        overwrittenCount++;
                    } else if (skipDuplicates) {
                        skippedCount++;
                        return;
                    } else {
                        // ä¸è·³è¿‡ä¹Ÿä¸è¦†ç›–ï¼Œæ·»åŠ æ–°çš„æ¡ç›®(ä¿®æ”¹æ ‡é¢˜)
                        poem.title = `${poem.title} (é‡å¤é¡¹)`;
                        poem.id = Date.now() + Math.random();
                        poems.push(poem);
                        importedCount++;
                    }
                } else {
                    // æ–°è¯—è¯
                    poem.id = Date.now() + Math.random();
                    poems.push(poem);
                    importedCount++;
                }
            });
            
            // ä¿å­˜å¹¶åˆ·æ–°
            if (importedCount > 0 || overwrittenCount > 0) {
                saveLocal();
                renderUI();
                closeModal('import-modal');
                
                // æ˜¾ç¤ºå¯¼å…¥ç»“æœ
                alert(`å¯¼å…¥å®Œæˆ!\næˆåŠŸå¯¼å…¥: ${importedCount} é¦–\nè¦†ç›–æ›´æ–°: ${overwrittenCount} é¦–\nè·³è¿‡é‡å¤: ${skippedCount} é¦–`);
            } else {
                errorContainer.textContent = 'æ²¡æœ‰å¯å¯¼å…¥çš„æ–°è¯—è¯ï¼Œæ‰€æœ‰å†…å®¹éƒ½å·²å­˜åœ¨';
            }
        }

        // è§£æç«–çº¿åˆ†éš”æ ¼å¼
        function parsePipeFormat(input) {
            const lines = input.split('\n');
            const poems = [];
            const errors = [];
            
            lines.forEach((line, index) => {
                const trimmed = line.trim();
                if (!trimmed) return; // è·³è¿‡ç©ºè¡Œ
                
                const parts = trimmed.split('|').map(p => p.trim());
                if (parts.length < 3) {
                    errors.push(`ç¬¬ ${index + 1} è¡Œæ ¼å¼é”™è¯¯ï¼Œè‡³å°‘éœ€è¦æ ‡é¢˜|ä½œè€…|å†…å®¹`);
                    return;
                }
                
                poems.push({
                    title: parts[0],
                    author: parts[1],
                    content: parts.slice(2).join('|') // å…è®¸å†…å®¹ä¸­åŒ…å«|
                });
            });
            
            return [poems, errors];
        }

        // è§£æJSONæ ¼å¼
        function parseJsonFormat(input) {
            try {
                const data = JSON.parse(input);
                const poems = [];
                const errors = [];
                
                if (!Array.isArray(data)) {
                    throw new Error('JSONæ ¼å¼åº”ä¸ºæ•°ç»„');
                }
                
                data.forEach((item, index) => {
                    if (!item.title || !item.author || !item.content) {
                        errors.push(`ç¬¬ ${index + 1} é¡¹ç¼ºå°‘å¿…è¦å­—æ®µ(title, author, content)`);
                        return;
                    }
                    
                    poems.push({
                        title: item.title.trim(),
                        author: item.author.trim(),
                        content: item.content.trim()
                    });
                });
                
                return [poems, errors];
            } catch (e) {
                throw new Error(`JSONè§£æå¤±è´¥: ${e.message}`);
            }
        }

        // è§£ææ™®é€šæ–‡æœ¬æ ¼å¼ (æ ‡é¢˜\nä½œè€…\nå†…å®¹\nç©ºè¡Œåˆ†éš”)
        function parsePlainTextFormat(input) {
            const blocks = input.split('\n\n').filter(block => block.trim());
            const poems = [];
            const errors = [];
            
            blocks.forEach((block, index) => {
                const lines = block.split('\n').filter(line => line.trim());
                if (lines.length < 3) {
                    errors.push(`ç¬¬ ${index + 1} é¦–æ ¼å¼é”™è¯¯ï¼Œéœ€è¦æ ‡é¢˜ã€ä½œè€…å’Œå†…å®¹`);
                    return;
                }
                
                poems.push({
                    title: lines[0].trim(),
                    author: lines[1].trim(),
                    content: lines.slice(2).join('\n').trim()
                });
            });
            
            return [poems, errors];
        }

        // --- è¾…åŠ©å‡½æ•° ---
        function showAuth() { document.getElementById('auth-modal').style.display='flex'; }
        function showImport() { document.getElementById('import-modal').style.display='flex'; }
        function closeModal(id) { document.getElementById(id).style.display='none'; }
        function resetAll() { if(confirm("ç¡®å®šæ¸…ç©ºé‡ç½®ï¼Ÿ")) { localStorage.removeItem('poem_data'); location.reload(); }}
        
        function fireConfetti() {
            const c=document.getElementById('confetti-canvas'),x=c.getContext('2d');
            c.width=innerWidth;c.height=innerHeight;
            let p=[];for(let i=0;i<120;i++)p.push({x:c.width/2,y:c.height/2,v:{x:(Math.random()-.5)*25,y:(Math.random()-.5)*25},c:`hsl(${Math.random()*120+100},80%,60%)`}); // ç»¿è‰²ç³»ç¤¼èŠ±
            (function f(){x.clearRect(0,0,c.width,c.height);p.forEach(k=>{k.x+=k.v.x;k.y+=k.v.y;k.v.y+=.5;x.fillStyle=k.c;x.fillRect(k.x,k.y,6,6)});if(p[0].y<c.height)requestAnimationFrame(f)})();
        }

        init();
    </script>
</body>
</html>